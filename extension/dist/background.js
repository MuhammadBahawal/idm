var d="com.mydm.native";var o=null;function i(){try{return o=chrome.runtime.connectNative(d),o.onMessage.addListener(e=>{console.log("[MyDM] Native message received:",e),chrome.storage.local.set({lastNativeResponse:e})}),o.onDisconnect.addListener(()=>{console.log("[MyDM] Native port disconnected:",chrome.runtime.lastError?.message),o=null,chrome.storage.local.set({connectionStatus:"disconnected"})}),chrome.storage.local.set({connectionStatus:"connected"}),console.log("[MyDM] Connected to native host"),o}catch(e){return console.error("[MyDM] Failed to connect:",e),chrome.storage.local.set({connectionStatus:"error"}),null}}function c(e){o||(o=i()),o?o.postMessage(e):console.error("[MyDM] Cannot send: not connected to native host")}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"mydm-download",title:"Download with MyDM",contexts:["link","image","video","audio"]}),chrome.contextMenus.create({id:"mydm-download-page",title:"Download page URL with MyDM",contexts:["page"]}),i(),c({type:"ping",payload:{}})});chrome.contextMenus.onClicked.addListener((e,t)=>{let n=e.linkUrl||e.srcUrl||e.pageUrl;n&&c({type:"add_download",payload:{url:n,referrer:t?.url||""}})});chrome.runtime.onMessage.addListener((e,t,n)=>(e.type==="download_with_mydm"&&(c({type:"add_download",payload:{url:e.url,filename:e.filename,referrer:t.tab?.url||""}}),n({success:!0})),e.type==="download_media"&&(c({type:"add_media_download",payload:{manifestUrl:e.manifestUrl,mediaType:e.mediaType,quality:e.quality,title:e.title,referrer:t.tab?.url||""}}),n({success:!0})),e.type==="get_connection_status"&&n({connected:o!==null}),e.type==="detected_media"&&(chrome.storage.local.get(["detectedMedia"],r=>{let a=r.detectedMedia||[];a.push({url:e.url,type:e.mediaType,tabId:t.tab?.id,title:t.tab?.title,timestamp:Date.now()}),chrome.storage.local.set({detectedMedia:a.slice(-50)})}),n({success:!0})),!0));chrome.webRequest&&chrome.webRequest.onCompleted.addListener(e=>{let t=e.url.toLowerCase();(t.includes(".m3u8")||t.includes(".mpd"))&&chrome.storage.local.get(["detectedMedia"],n=>{let r=n.detectedMedia||[],a=t.includes(".m3u8")?"hls":"dash";r.push({url:e.url,type:a,tabId:e.tabId,timestamp:Date.now()}),chrome.storage.local.set({detectedMedia:r.slice(-50)})})},{urls:["<all_urls>"],types:["xmlhttprequest","media","other"]});
