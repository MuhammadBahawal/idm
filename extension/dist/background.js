var D="com.mydm.native";var S=new Set(["zip","rar","7z","tar","gz","bz2","xz","iso","exe","msi","dmg","deb","rpm","apk","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","mp4","mkv","avi","mov","wmv","flv","webm","m4v","mp3","flac","wav","aac","ogg","wma","m4a","jpg","jpeg","png","gif","bmp","svg","webp"]),d=null,h="",c=new Map,p=new Map,R={17:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!0,muxed:!0},18:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},22:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},37:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},38:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!0,muxed:!0},43:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},44:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},45:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},46:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},59:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},78:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},133:{qualityLabel:"240p",height:240,hasVideo:!0,hasAudio:!1,muxed:!1},134:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!1,muxed:!1},135:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!1,muxed:!1},136:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},137:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},140:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},160:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!1,muxed:!1},247:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},248:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},249:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},250:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},251:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},298:{qualityLabel:"720p60",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},299:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},303:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},313:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1},315:{qualityLabel:"2160p60",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1}};function v(){return new Date().toISOString()}function w(e){return e instanceof Error?e.message:String(e)}function l(e,r,t={}){let n={ts:v(),level:e,event:r,...t};e==="error"?console.error("[MyDM]",r,t):e==="warn"?console.warn("[MyDM]",r,t):console.log("[MyDM]",r,t),chrome.storage.local.get(["debugLogs"],s=>{let o=s.debugLogs||[];o.push(n),chrome.storage.local.set({debugLogs:o.slice(-300),lastDebugLogAt:Date.now()})})}function g(e,r=""){chrome.storage.local.set({connectionStatus:e,disconnectReason:r,lastConnectionStateAt:Date.now()})}function _(e){let r=e.payload;return r&&typeof r=="object"?r:void 0}function E(e){let t=_(e)?.requestId;return typeof t=="string"?t:void 0}function T(e){if(e.type==="error"){let t=_(e)?.message;return typeof t=="string"&&t.trim().length>0?t:"Native host returned an error"}}function k(e){for(let[r,t]of c.entries())clearTimeout(t.timer),t.resolve({success:!1,error:e,requestId:r});c.clear()}function C(e){let r=E(e),t=T(e);if(l("info","native.message",{requestId:r,type:e.type??"unknown"}),chrome.storage.local.set({lastNativeResponse:e,lastNativeResponseAt:Date.now()}),!r)return;let n=c.get(r);n&&(clearTimeout(n.timer),c.delete(r),n.resolve({success:!t,error:t,response:e,requestId:r}))}function U(){let e=chrome.runtime.lastError?.message||"Native host disconnected";l("warn","native.disconnected",{reason:e}),h=e,d=null,g("disconnected",e),k(e)}function V(){if(d)return d;g("connecting");try{return d=chrome.runtime.connectNative(D),d.onMessage.addListener(C),d.onDisconnect.addListener(U),h="",g("connected"),l("info","native.connected"),d}catch(e){let r=w(e);return l("error","native.connect_failed",{reason:r}),h=r,g("error",r),d=null,null}}function y(e,r){let t=V();if(!t)return Promise.resolve({success:!1,error:h||"Native host not available. Is MyDM desktop app running?"});let n=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,s={type:e,payload:{...r,requestId:n,source:"extension-background",sentAt:v()}};return new Promise(o=>{let a=setTimeout(()=>{c.delete(n),o({success:!1,error:"Timed out waiting for native host response",requestId:n})},15e3);c.set(n,{resolve:o,timer:a});try{t.postMessage(s),l("info","native.request_sent",{requestId:n,type:e})}catch(u){clearTimeout(a),c.delete(n),o({success:!1,error:`Failed to send request: ${w(u)}`,requestId:n})}})}async function x(){return y("healthcheck",{})}function P(e){try{let t=new URL(e).pathname.split("/").pop()||"",n=t.lastIndexOf(".");return n<=0?null:t.slice(n+1).toLowerCase()}catch{return null}}function I(e){let r=P(e);return r!==null&&S.has(r)}function N(e,r){let t=e.searchParams.get(r);if(!t)return;let n=Number.parseInt(t,10);return Number.isFinite(n)?n:void 0}function O(e){if(!e)return 0;let r=e.match(/(\d{3,4})p/i);if(!r)return 0;let t=Number.parseInt(r[1],10);return Number.isFinite(t)?t:0}function B(e){let r=e.toLowerCase();return r.includes("googlevideo.com")||r.endsWith("youtube.com")||r==="youtu.be"}function X(e,r){if(r<0)return null;let t;try{t=new URL(e)}catch{return null}let n=t.hostname.toLowerCase(),s=N(t,"itag"),o=s!==void 0?R[s]:void 0,a=t.searchParams.get("mime")||void 0,u=o?.qualityLabel||t.searchParams.get("quality_label")||t.searchParams.get("quality")||void 0,i=o?.height||O(u),m=o?.hasVideo??!1,f=o?.hasAudio??!1;if(!o&&a){let q=a.toLowerCase();q.startsWith("video/")&&(m=!0),q.startsWith("audio/")&&(f=!0)}let A=!!(a||t.searchParams.get("clen")||t.searchParams.get("dur")||t.searchParams.get("mime"));return!m&&!f&&!A||!B(n)&&!I(e)&&!A?null:{url:e,tabId:r,timestamp:Date.now(),host:n,mimeType:a,itag:s,qualityLabel:u,height:i,hasVideo:m,hasAudio:f,muxed:o?.muxed??(m&&f)}}function F(e){let r=p.get(e.tabId)||[];r.some(t=>t.url===e.url)||(r.push(e),r.sort((t,n)=>n.timestamp-t.timestamp),p.set(e.tabId,r.slice(0,300)))}function L(e,r){let t=r&&e.muxed?1e6:0,n=r&&e.hasAudio?25e4:0,s=e.hasVideo?1e5:0,o=e.height*1e3,a=Math.floor(e.timestamp/1e3);return t+n+s+o+a}function $(e,r){return[...e].sort((t,n)=>L(n,r)-L(t,r))}function z(e,r){if(!r)return e;try{let n=new URL(r).hostname.toLowerCase();if(n.includes("youtube.com")||n==="youtu.be"||n==="m.youtube.com"){let s=e.filter(o=>o.host.includes("googlevideo.com"));if(s.length>0)return s}return e}catch{return e}}function G(e,r,t=!0){let n=p.get(e)||[];if(n.length===0)return null;let s=z(n.filter(a=>a.hasVideo||a.muxed),r);return s.length===0?null:$(s,t)[0]||null}function M(e){chrome.storage.local.get(["detectedMedia"],r=>{let t=r.detectedMedia||[];t.some(s=>s.url===e.url&&s.type===e.type&&s.tabId===e.tabId)||(t.push(e),chrome.storage.local.set({detectedMedia:t.slice(-100)}))})}function b(e){chrome.storage.local.get(["detectedResources"],r=>{let t=r.detectedResources||[];t.some(s=>s.url===e.url&&s.kind===e.kind&&s.tabId===e.tabId)||(t.push(e),chrome.storage.local.set({detectedResources:t.slice(-200)}))})}function H(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"mydm-download",title:"Download with MyDM",contexts:["link","image","video","audio"]}),chrome.contextMenus.create({id:"mydm-download-page",title:"Download page URL with MyDM",contexts:["page"]})})}chrome.runtime.onInstalled.addListener(()=>{H(),x()});chrome.runtime.onStartup.addListener(()=>{x()});chrome.tabs.onRemoved.addListener(e=>{p.delete(e)});chrome.contextMenus.onClicked.addListener((e,r)=>{let t=e.linkUrl||e.srcUrl||e.pageUrl;t&&y("add_download",{url:t,referrer:r?.url||"",filename:e.selectionText||void 0})});chrome.runtime.onMessage.addListener((e,r,t)=>{let n=e.requestId||(typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`);return l("info","runtime.message",{requestId:n,type:e.type}),(async()=>{try{switch(e.type){case"download_with_mydm":{if(!e.url){t({success:!1,error:"Missing URL",requestId:n});return}let o=r.tab,a=await y("add_download",{url:e.url,filename:e.filename,referrer:o?.url||"",headers:e.headers||{}});t({success:a.success,error:a.error,requestId:a.requestId||n});return}case"download_media":{if(!e.manifestUrl){t({success:!1,error:"Missing manifestUrl",requestId:n});return}let o=r.tab,a=await y("add_media_download",{manifestUrl:e.manifestUrl,mediaType:e.mediaType||"hls",quality:e.quality,title:e.title||o?.title||"",referrer:o?.url||"",headers:e.headers||{}});t({success:a.success,error:a.error,requestId:a.requestId||n});return}case"get_connection_status":{let o=await x();t({connected:o.success,disconnectReason:o.success?"":o.error||h,requestId:o.requestId||n});return}case"resolve_video_source":{let o=r.tab?.id;if(typeof o!="number"){t({success:!1,error:"Cannot resolve source without tab context",requestId:n});return}let a=e.pageUrl||r.tab?.url||"",u=e.preferMuxed!==!1,i=G(o,a,u);if(!i){t({success:!1,error:"No downloadable stream detected yet. Let the video play for a few seconds and try again.",requestId:n});return}l("info","stream.resolved",{requestId:n,tabId:o,pageUrl:a,url:i.url,itag:i.itag,quality:i.qualityLabel,muxed:i.muxed}),t({success:!0,requestId:n,url:i.url,quality:i.qualityLabel||"",mimeType:i.mimeType||"",muxed:i.muxed});return}case"detected_media":{e.url&&M({url:e.url,type:e.mediaType||"unknown",tabId:r.tab?.id,title:r.tab?.title||"",timestamp:Date.now()}),t({success:!0,requestId:n});return}case"detected_resources":{let o=e.resources||[];for(let a of o){let u=a.url,i=a.kind;typeof u!="string"||typeof i!="string"||b({...a,tabId:r.tab?.id,title:r.tab?.title||"",timestamp:Date.now()})}t({success:!0,requestId:n,count:o.length});return}default:{t({success:!1,error:`Unsupported message type: ${e.type}`,requestId:n});return}}}catch(o){let a=w(o);l("error","runtime.message_failed",{requestId:n,type:e.type,error:a}),t({success:!1,error:a,requestId:n})}})(),!0});chrome.webRequest&&chrome.webRequest.onCompleted.addListener(e=>{let r=e.url.toLowerCase();if(r.includes(".m3u8")||r.includes(".mpd")){let n=r.includes(".m3u8")?"hls":"dash";M({url:e.url,type:n,tabId:e.tabId,timestamp:Date.now()})}else I(e.url)&&b({url:e.url,kind:"network_file",tabId:e.tabId,timestamp:Date.now()});let t=X(e.url,e.tabId);t&&(F(t),t.hasVideo&&b({url:t.url,kind:t.muxed?"network_video_muxed":"network_video_stream",tabId:e.tabId,timestamp:t.timestamp}))},{urls:["<all_urls>"],types:["xmlhttprequest","media","main_frame","sub_frame","other"]});
