var z="com.mydm.native";var P=["video/","audio/"],Y=new Set(["zip","rar","7z","tar","gz","bz2","xz","iso","exe","msi","dmg","deb","rpm","apk","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","mp4","mkv","avi","mov","wmv","flv","webm","m4v","mp3","flac","wav","aac","ogg","wma","m4a","jpg","jpeg","png","gif","bmp","svg","webp"]),p=null,R="",w=new Map,f=new Map,Q={17:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!0,muxed:!0},18:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},22:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},37:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},38:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!0,muxed:!0},43:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},44:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},45:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},46:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},59:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},78:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},133:{qualityLabel:"240p",height:240,hasVideo:!0,hasAudio:!1,muxed:!1},134:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!1,muxed:!1},135:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!1,muxed:!1},136:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},137:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},140:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},160:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!1,muxed:!1},247:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},248:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},249:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},250:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},251:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},298:{qualityLabel:"720p60",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},299:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},303:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},313:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1},315:{qualityLabel:"2160p60",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1}};async function J(e){try{let t=new URL(e),r=await chrome.cookies.getAll({url:t.origin});return r.length===0?"":r.map(o=>`${o.name}=${o.value}`).join("; ")}catch{return""}}async function A(e,t){let r={...t||{}},o=await J(e);return o&&(r.Cookie=o),r}function O(){return new Date().toISOString()}function v(e){return e instanceof Error?e.message:String(e)}function c(e,t,r={}){let o={ts:O(),level:e,event:t,...r};e==="error"?console.error("[MyDM]",t,r):e==="warn"?console.warn("[MyDM]",t,r):console.log("[MyDM]",t,r),chrome.storage.local.get(["debugLogs"],i=>{let n=i.debugLogs||[];n.push(o),chrome.storage.local.set({debugLogs:n.slice(-300),lastDebugLogAt:Date.now()})})}function x(e,t=""){chrome.storage.local.set({connectionStatus:e,disconnectReason:t,lastConnectionStateAt:Date.now()})}function H(e){let t=e.payload;return t&&typeof t=="object"?t:void 0}function K(e){let r=H(e)?.requestId;return typeof r=="string"?r:void 0}function Z(e){if(e.type==="error"){let r=H(e)?.message;return typeof r=="string"&&r.trim().length>0?r:"Native host returned an error"}}function ee(e){for(let[t,r]of w.entries())clearTimeout(r.timer),r.resolve({success:!1,error:e,requestId:t});w.clear()}function te(e){let t=K(e),r=Z(e);if(c("info","native.message",{requestId:t,type:e.type??"unknown"}),chrome.storage.local.set({lastNativeResponse:e,lastNativeResponseAt:Date.now()}),!t)return;let o=w.get(t);o&&(clearTimeout(o.timer),w.delete(t),o.resolve({success:!r,error:r,response:e,requestId:t}))}function re(){let e=chrome.runtime.lastError?.message||"Native host disconnected";c("warn","native.disconnected",{reason:e}),R=e,p=null,x("disconnected",e),ee(e)}function oe(){if(p)return p;x("connecting");try{return p=chrome.runtime.connectNative(z),p.onMessage.addListener(te),p.onDisconnect.addListener(re),R="",x("connected"),c("info","native.connected"),p}catch(e){let t=v(e);return c("error","native.connect_failed",{reason:t}),R=t,x("error",t),p=null,null}}function q(e,t){let r=oe();if(!r)return Promise.resolve({success:!1,error:R||"Native host not available. Is MyDM desktop app running?"});let o=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={type:e,payload:{...t,requestId:o,source:"extension-background",sentAt:O()}};return new Promise(n=>{let a=setTimeout(()=>{w.delete(o),n({success:!1,error:"Timed out waiting for native host response",requestId:o})},15e3);w.set(o,{resolve:n,timer:a});try{r.postMessage(i),c("info","native.request_sent",{requestId:o,type:e})}catch(s){clearTimeout(a),w.delete(o),n({success:!1,error:`Failed to send request: ${v(s)}`,requestId:o})}})}function k(e,t){return new Promise((r,o)=>{let i={url:e};t&&(i.filename=t.replace(/[/\\]/g,"_")),chrome.downloads.download(i,n=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}if(typeof n!="number"){o(new Error("Download did not start"));return}c("info","download.chrome_fallback_started",{downloadId:n,url:e.substring(0,100),filename:t}),r(n)})})}async function T(){return q("healthcheck",{})}function ne(e){try{let r=new URL(e).pathname.split("/").pop()||"",o=r.lastIndexOf(".");return o<=0?null:r.slice(o+1).toLowerCase()}catch{return null}}function F(e){let t=ne(e);return t!==null&&Y.has(t)}function B(e,t){let r=e.searchParams.get(t);if(!r)return;let o=Number.parseInt(r,10);return Number.isFinite(o)?o:void 0}function ie(e){if(!e)return 0;let t=e.match(/(\d{3,4})p/i);if(!t)return 0;let r=Number.parseInt(t[1],10);return Number.isFinite(r)?r:0}function ae(e){let t=e.toLowerCase();return t.includes("googlevideo.com")||t.endsWith("youtube.com")||t==="youtu.be"}function $(e){try{let r=new URL(e).hostname.toLowerCase();return r.includes("googlevideo.com")?!1:r.endsWith("youtube.com")||r==="youtu.be"||r==="m.youtube.com"}catch{return!1}}function W(e){return(e||"unknown").toLowerCase()}function I(e){let t=W(e);return t==="webrequest"?95e4:t==="fetch"||t==="xhr"?9e5:t.endsWith("_api")?5e5:t==="json_parse"||t==="json_parse_nested"?45e4:t==="global_var"||t==="ytplayer_config"||t==="player_api"?35e4:15e4}function se(e){let t=B(e,"expire");if(t===void 0)return!0;let r=Math.floor(Date.now()/1e3),o=r+7*24*60*60,i=r-24*60*60;return t>=i&&t<=o}var E=new Map;function X(e,t,r,o){if(t<0)return null;let i;try{i=new URL(e)}catch{return null}let n=i.hostname.toLowerCase(),a=ae(n),s=W(o),u=B(i,"itag"),l=u!==void 0?Q[u]:void 0,m=i.searchParams.get("mime"),_=m||r||void 0,d=l?.qualityLabel||i.searchParams.get("quality_label")||i.searchParams.get("quality")||void 0,y=l?.height||ie(d),h=l?.hasVideo??!1,g=l?.hasAudio??!1;if(!l&&_){let b=_.toLowerCase();b.startsWith("video/")&&(h=!0),b.startsWith("audio/")&&(g=!0)}let M=a&&i.pathname.includes("/videoplayback");if(M&&!h&&!g)if(m){let b=decodeURIComponent(m).toLowerCase();b.startsWith("video/")?h=!0:b.startsWith("audio/")?g=!0:h=!0}else h=!0;let U=!!(_||i.searchParams.get("clen")||i.searchParams.get("dur")||i.searchParams.get("mime"));if(a&&i.pathname.includes("/videoplayback")&&!se(i))return null;let C=r?P.some(b=>r.toLowerCase().startsWith(b)):!1;return!h&&!g&&!U&&!C&&!M||!a&&!F(e)&&!U&&!C?null:{url:e,tabId:t,timestamp:Date.now(),host:n,source:s,mimeType:_,itag:u,qualityLabel:d,height:y,hasVideo:h,hasAudio:g,muxed:l?.muxed??(h&&g)}}function j(e){let t=f.get(e.tabId)||[],r=t.findIndex(o=>o.url===e.url);if(r>=0){let o=t[r],i=I(o.source);if(I(e.source)<=i)return;t[r]=e,t.sort((a,s)=>s.timestamp-a.timestamp),f.set(e.tabId,t.slice(0,300)),L();return}t.push(e),t.sort((o,i)=>i.timestamp-o.timestamp),f.set(e.tabId,t.slice(0,300)),L()}function L(){let e={};f.forEach((t,r)=>{e[String(r)]=t}),chrome.storage.session?.set({_streamCandidates:e}).catch(()=>{})}async function ue(){try{let t=(await chrome.storage.session?.get("_streamCandidates"))?._streamCandidates;if(!t)return;for(let[r,o]of Object.entries(t)){let i=Number(r);!isNaN(i)&&Array.isArray(o)&&f.set(i,o)}c("info","stream_candidates.restored",{tabs:Object.keys(t).length,total:[...f.values()].reduce((r,o)=>r+o.length,0)})}catch{}}ue();function N(e,t){let r=I(e.source),o=t&&e.muxed?1e6:0,i=t&&e.hasAudio?25e4:0,n=e.hasVideo?1e5:0,a=e.height*1e3,s=Math.floor(e.timestamp/1e3);return r+o+i+n+a+s}function de(e,t){return[...e].sort((r,o)=>N(o,t)-N(r,t))}function D(e,t){if(!t)return e;try{let o=new URL(t).hostname.toLowerCase();if(o.includes("youtube.com")||o==="youtu.be"||o==="m.youtube.com"){let i=e.filter(n=>n.host.includes("googlevideo.com"));if(i.length>0)return i}return e}catch{return e}}function ce(e,t,r=!0){let o=f.get(e)||[];if(o.length===0)return null;let i=D(o.filter(a=>a.hasVideo||a.muxed),t);return i.length===0?null:de(i,r)[0]||null}function V(e,t){let r=f.get(e)||[];if(r.length===0)return null;let o=D(r.filter(n=>n.hasAudio&&!n.hasVideo),t);if(o.length===0)return null;let i=[251,250,249,140];for(let n of i){let a=o.find(s=>s.itag===n);if(a)return a}return o.sort((n,a)=>a.timestamp-n.timestamp)[0]||null}function G(e){chrome.storage.local.get(["detectedMedia"],t=>{let r=t.detectedMedia||[];r.some(i=>i.url===e.url&&i.type===e.type&&i.tabId===e.tabId)||(r.push(e),chrome.storage.local.set({detectedMedia:r.slice(-100)}))})}function S(e){chrome.storage.local.get(["detectedResources"],t=>{let r=t.detectedResources||[];r.some(i=>i.url===e.url&&i.kind===e.kind&&i.tabId===e.tabId)||(r.push(e),chrome.storage.local.set({detectedResources:r.slice(-200)}))})}function le(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"mydm-download",title:"Download with MyDM",contexts:["link","image","video","audio"]}),chrome.contextMenus.create({id:"mydm-download-page",title:"Download page URL with MyDM",contexts:["page"]})})}chrome.runtime.onInstalled.addListener(()=>{le(),T(),me()});chrome.runtime.onStartup.addListener(()=>{T()});async function me(){try{await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[1,2]}),await chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{header:"Referer",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"https://www.youtube.com/"}]},condition:{urlFilter:"*://*.googlevideo.com/*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.MEDIA,chrome.declarativeNetRequest.ResourceType.OTHER]}},{id:2,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{header:"Origin",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"https://www.youtube.com"}]},condition:{urlFilter:"*://*.googlevideo.com/*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.MEDIA,chrome.declarativeNetRequest.ResourceType.OTHER]}}]}),c("info","header_rules.installed",{rules:2})}catch(r){c("error","header_rules.install_failed",{error:v(r)})}}chrome.tabs.onRemoved.addListener(e=>{f.delete(e),L()});chrome.contextMenus.onClicked.addListener((e,t)=>{let r=e.linkUrl||e.srcUrl||e.pageUrl;if(r){if($(r)){c("warn","context_menu.youtube_page_blocked",{url:r});return}q("add_download",{url:r,referrer:t?.url||"",filename:e.selectionText||void 0})}});chrome.runtime.onMessage.addListener((e,t,r)=>{let o=e.requestId||(typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`);return c("info","runtime.message",{requestId:o,type:e.type}),(async()=>{try{switch(e.type){case"download_with_mydm":{if(!e.url){r({success:!1,error:"Missing URL",requestId:o});return}if($(e.url)){r({success:!1,error:"Open the YouTube video and use the in-player MyDM button to capture downloadable streams.",requestId:o});return}let n=t.tab,a=await A(e.url,e.headers||{}),s=await q("add_download",{url:e.url,filename:e.filename,referrer:n?.url||"",headers:a});if(s.success){r({success:!0,error:s.error,requestId:s.requestId||o});return}c("info","download.fallback_chrome",{requestId:o,url:e.url.substring(0,100),nativeError:s.error});try{let u=await k(e.url,e.filename);r({success:!0,requestId:o,downloadId:u})}catch(u){r({success:!1,error:`Download failed: ${v(u)}`,requestId:o})}return}case"download_media":{if(!e.manifestUrl){r({success:!1,error:"Missing manifestUrl",requestId:o});return}let n=t.tab,a=await A(e.manifestUrl,e.headers||{}),s=await q("add_media_download",{manifestUrl:e.manifestUrl,mediaType:e.mediaType||"hls",quality:e.quality,title:e.title||n?.title||"",referrer:n?.url||"",headers:a});r({success:s.success,error:s.error,requestId:s.requestId||o});return}case"download_video":{if(!e.videoUrl){r({success:!1,error:"Missing videoUrl",requestId:o});return}let n=t.tab,a=await A(e.videoUrl,e.headers||{}),s=await q("add_video_download",{videoUrl:e.videoUrl,audioUrl:e.audioUrl||"",filename:e.filename,quality:e.quality,title:e.title||n?.title||"",referrer:n?.url||"",headers:a});if(s.success){r({success:!0,error:s.error,requestId:s.requestId||o});return}c("info","download_video.fallback_chrome",{requestId:o,videoUrl:e.videoUrl.substring(0,100),nativeError:s.error});try{let u=await k(e.videoUrl,e.filename);r({success:!0,requestId:o,downloadId:u})}catch(u){r({success:!1,error:`Download failed: ${v(u)}`,requestId:o})}return}case"get_connection_status":{let n=await T();r({connected:n.success,disconnectReason:n.success?"":n.error||R,requestId:n.requestId||o});return}case"resolve_video_source":{let n=t.tab?.id;if(typeof n!="number"){r({success:!1,error:"Cannot resolve source without tab context",requestId:o});return}let a=e.pageUrl||t.tab?.url||"",s=e.preferMuxed!==!1,u=ce(n,a,s);if(!u){r({success:!1,error:"No downloadable stream detected yet. Let the video play for a few seconds and try again.",requestId:o});return}let l="";if(!u.muxed&&u.hasVideo){let m=V(n,a);m&&(l=m.url)}c("info","stream.resolved",{requestId:o,tabId:n,pageUrl:a,url:u.url,audioUrl:l||void 0,itag:u.itag,quality:u.qualityLabel,muxed:u.muxed}),r({success:!0,requestId:o,url:u.url,audioUrl:l,quality:u.qualityLabel||"",mimeType:u.mimeType||"",muxed:u.muxed});return}case"list_stream_qualities":{let n=t.tab?.id;if(typeof n!="number"){r({success:!1,error:"No tab context",requestId:o});return}let a=e.pageUrl||t.tab?.url||"",s=f.get(n)||[],u=D(s,a),l=new Set,m=[],_=[...u].sort((d,y)=>d.muxed!==y.muxed?d.muxed?-1:1:y.height-d.height);for(let d of _){if(!d.hasVideo)continue;let y=`${d.qualityLabel||d.height}-${d.muxed?"m":"s"}`;if(l.has(y))continue;l.add(y);let h="";if(!d.muxed){let g=V(n,a);g&&(h=g.url)}m.push({url:d.url,audioUrl:h,itag:d.itag,quality:d.qualityLabel||`${d.height}p`,mimeType:d.mimeType||"",muxed:d.muxed,height:d.height,hasVideo:d.hasVideo,hasAudio:d.hasAudio})}c("info","stream.list_qualities",{tabId:n,count:m.length,qualities:m.map(d=>d.quality)}),r({success:!0,requestId:o,qualities:m});return}case"detected_media":{e.url&&G({url:e.url,type:e.mediaType||"unknown",tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()}),r({success:!0,requestId:o});return}case"detected_resources":{let n=e.resources||[];for(let a of n){let s=a.url,u=a.kind;typeof s!="string"||typeof u!="string"||S({...a,tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()})}r({success:!0,requestId:o,count:n.length});return}case"report_stream_url":{let n=e.url,a=t.tab?.id;if(typeof n=="string"&&typeof a=="number"){let s=X(n,a,void 0,e.streamSource);s?(j(s),c("info","stream.accepted",{tabId:a,url:n.substring(0,100),source:s.source,itag:s.itag,quality:s.qualityLabel,muxed:s.muxed,hasVideo:s.hasVideo,hasAudio:s.hasAudio})):c("warn","stream.rejected_by_filter",{tabId:a,url:n.substring(0,120),source:e.streamSource||"unknown"})}r({success:!0,requestId:o});return}default:{r({success:!1,error:`Unsupported message type: ${e.type}`,requestId:o});return}}}catch(n){let a=v(n);c("error","runtime.message_failed",{requestId:o,type:e.type,error:a}),r({success:!1,error:a,requestId:o})}})(),!0});chrome.webRequest&&(chrome.webRequest.onHeadersReceived.addListener(e=>{if(e.responseHeaders){for(let t of e.responseHeaders)if(t.name.toLowerCase()==="content-type"&&t.value){let r=t.value.toLowerCase();P.some(o=>r.startsWith(o))&&E.set(e.requestId,t.value);break}}},{urls:["<all_urls>"],types:["xmlhttprequest","media","other"]},["responseHeaders"]),chrome.webRequest.onCompleted.addListener(e=>{let t=e.url.toLowerCase(),r=E.get(e.requestId);if(E.delete(e.requestId),t.includes(".m3u8")||t.includes(".mpd")){let i=t.includes(".m3u8")?"hls":"dash";G({url:e.url,type:i,tabId:e.tabId,timestamp:Date.now()})}else F(e.url)&&S({url:e.url,kind:"network_file",tabId:e.tabId,timestamp:Date.now()});let o=X(e.url,e.tabId,r,"webrequest");o&&(j(o),o.hasVideo&&S({url:o.url,kind:o.muxed?"network_video_muxed":"network_video_stream",tabId:e.tabId,timestamp:o.timestamp}))},{urls:["<all_urls>"],types:["xmlhttprequest","media","main_frame","sub_frame","other"]}));
