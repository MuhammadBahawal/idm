var B="com.mydm.native";var C=["video/","audio/"],$=new Set(["zip","rar","7z","tar","gz","bz2","xz","iso","exe","msi","dmg","deb","rpm","apk","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","mp4","mkv","avi","mov","wmv","flv","webm","m4v","mp3","flac","wav","aac","ogg","wma","m4a","jpg","jpeg","png","gif","bmp","svg","webp"]),g=null,_="",y=new Map,f=new Map,X={17:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!0,muxed:!0},18:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},22:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},37:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},38:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!0,muxed:!0},43:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!0,muxed:!0},44:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},45:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!0,muxed:!0},46:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!0,muxed:!0},59:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},78:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!0,muxed:!0},133:{qualityLabel:"240p",height:240,hasVideo:!0,hasAudio:!1,muxed:!1},134:{qualityLabel:"360p",height:360,hasVideo:!0,hasAudio:!1,muxed:!1},135:{qualityLabel:"480p",height:480,hasVideo:!0,hasAudio:!1,muxed:!1},136:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},137:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},140:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},160:{qualityLabel:"144p",height:144,hasVideo:!0,hasAudio:!1,muxed:!1},247:{qualityLabel:"720p",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},248:{qualityLabel:"1080p",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},249:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},250:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},251:{qualityLabel:"Audio",height:0,hasVideo:!1,hasAudio:!0,muxed:!1},298:{qualityLabel:"720p60",height:720,hasVideo:!0,hasAudio:!1,muxed:!1},299:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},303:{qualityLabel:"1080p60",height:1080,hasVideo:!0,hasAudio:!1,muxed:!1},313:{qualityLabel:"2160p",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1},315:{qualityLabel:"2160p60",height:2160,hasVideo:!0,hasAudio:!1,muxed:!1}};async function W(e){try{let t=new URL(e),r=await chrome.cookies.getAll({url:t.origin});return r.length===0?"":r.map(o=>`${o.name}=${o.value}`).join("; ")}catch{return""}}async function x(e,t){let r={...t||{}},o=await W(e);return o&&(r.Cookie=o),r}function k(){return new Date().toISOString()}function b(e){return e instanceof Error?e.message:String(e)}function l(e,t,r={}){let o={ts:k(),level:e,event:t,...r};e==="error"?console.error("[MyDM]",t,r):e==="warn"?console.warn("[MyDM]",t,r):console.log("[MyDM]",t,r),chrome.storage.local.get(["debugLogs"],s=>{let n=s.debugLogs||[];n.push(o),chrome.storage.local.set({debugLogs:n.slice(-300),lastDebugLogAt:Date.now()})})}function R(e,t=""){chrome.storage.local.set({connectionStatus:e,disconnectReason:t,lastConnectionStateAt:Date.now()})}function N(e){let t=e.payload;return t&&typeof t=="object"?t:void 0}function G(e){let r=N(e)?.requestId;return typeof r=="string"?r:void 0}function j(e){if(e.type==="error"){let r=N(e)?.message;return typeof r=="string"&&r.trim().length>0?r:"Native host returned an error"}}function Q(e){for(let[t,r]of y.entries())clearTimeout(r.timer),r.resolve({success:!1,error:e,requestId:t});y.clear()}function z(e){let t=G(e),r=j(e);if(l("info","native.message",{requestId:t,type:e.type??"unknown"}),chrome.storage.local.set({lastNativeResponse:e,lastNativeResponseAt:Date.now()}),!t)return;let o=y.get(t);o&&(clearTimeout(o.timer),y.delete(t),o.resolve({success:!r,error:r,response:e,requestId:t}))}function Y(){let e=chrome.runtime.lastError?.message||"Native host disconnected";l("warn","native.disconnected",{reason:e}),_=e,g=null,R("disconnected",e),Q(e)}function J(){if(g)return g;R("connecting");try{return g=chrome.runtime.connectNative(B),g.onMessage.addListener(z),g.onDisconnect.addListener(Y),_="",R("connected"),l("info","native.connected"),g}catch(e){let t=b(e);return l("error","native.connect_failed",{reason:t}),_=t,R("error",t),g=null,null}}function q(e,t){let r=J();if(!r)return Promise.resolve({success:!1,error:_||"Native host not available. Is MyDM desktop app running?"});let o=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,s={type:e,payload:{...t,requestId:o,source:"extension-background",sentAt:k()}};return new Promise(n=>{let i=setTimeout(()=>{y.delete(o),n({success:!1,error:"Timed out waiting for native host response",requestId:o})},15e3);y.set(o,{resolve:n,timer:i});try{r.postMessage(s),l("info","native.request_sent",{requestId:o,type:e})}catch(a){clearTimeout(i),y.delete(o),n({success:!1,error:`Failed to send request: ${b(a)}`,requestId:o})}})}function U(e,t){return new Promise((r,o)=>{let s={url:e};t&&(s.filename=t.replace(/[/\\]/g,"_")),chrome.downloads.download(s,n=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}if(typeof n!="number"){o(new Error("Download did not start"));return}l("info","download.chrome_fallback_started",{downloadId:n,url:e.substring(0,100),filename:t}),r(n)})})}async function L(){return q("healthcheck",{})}function K(e){try{let r=new URL(e).pathname.split("/").pop()||"",o=r.lastIndexOf(".");return o<=0?null:r.slice(o+1).toLowerCase()}catch{return null}}function V(e){let t=K(e);return t!==null&&$.has(t)}function Z(e,t){let r=e.searchParams.get(t);if(!r)return;let o=Number.parseInt(r,10);return Number.isFinite(o)?o:void 0}function ee(e){if(!e)return 0;let t=e.match(/(\d{3,4})p/i);if(!t)return 0;let r=Number.parseInt(t[1],10);return Number.isFinite(r)?r:0}function te(e){let t=e.toLowerCase();return t.includes("googlevideo.com")||t.endsWith("youtube.com")||t==="youtu.be"}var E=new Map;function P(e,t,r){if(t<0)return null;let o;try{o=new URL(e)}catch{return null}let s=o.hostname.toLowerCase(),n=te(s),i=Z(o,"itag"),a=i!==void 0?X[i]:void 0,d=o.searchParams.get("mime"),h=d||r||void 0,m=a?.qualityLabel||o.searchParams.get("quality_label")||o.searchParams.get("quality")||void 0,A=a?.height||ee(m),u=a?.hasVideo??!1,c=a?.hasAudio??!1;if(!a&&h){let p=h.toLowerCase();p.startsWith("video/")&&(u=!0),p.startsWith("audio/")&&(c=!0)}let w=n&&o.pathname.includes("/videoplayback");if(w&&!u&&!c)if(d){let p=decodeURIComponent(d).toLowerCase();p.startsWith("video/")?u=!0:p.startsWith("audio/")?c=!0:u=!0}else u=!0;let v=!!(h||o.searchParams.get("clen")||o.searchParams.get("dur")||o.searchParams.get("mime")),D=r?C.some(p=>r.toLowerCase().startsWith(p)):!1;return!u&&!c&&!v&&!D&&!w||!n&&!V(e)&&!v&&!D?null:{url:e,tabId:t,timestamp:Date.now(),host:s,mimeType:h,itag:i,qualityLabel:m,height:A,hasVideo:u,hasAudio:c,muxed:a?.muxed??(u&&c)}}function O(e){let t=f.get(e.tabId)||[];t.some(r=>r.url===e.url)||(t.push(e),t.sort((r,o)=>o.timestamp-r.timestamp),f.set(e.tabId,t.slice(0,300)),H())}function H(){let e={};f.forEach((t,r)=>{e[String(r)]=t}),chrome.storage.session?.set({_streamCandidates:e}).catch(()=>{})}async function re(){try{let t=(await chrome.storage.session?.get("_streamCandidates"))?._streamCandidates;if(!t)return;for(let[r,o]of Object.entries(t)){let s=Number(r);!isNaN(s)&&Array.isArray(o)&&f.set(s,o)}l("info","stream_candidates.restored",{tabs:Object.keys(t).length,total:[...f.values()].reduce((r,o)=>r+o.length,0)})}catch{}}re();function M(e,t){let r=t&&e.muxed?1e6:0,o=t&&e.hasAudio?25e4:0,s=e.hasVideo?1e5:0,n=e.height*1e3,i=Math.floor(e.timestamp/1e3);return r+o+s+n+i}function oe(e,t){return[...e].sort((r,o)=>M(o,t)-M(r,t))}function T(e,t){if(!t)return e;try{let o=new URL(t).hostname.toLowerCase();if(o.includes("youtube.com")||o==="youtu.be"||o==="m.youtube.com"){let s=e.filter(n=>n.host.includes("googlevideo.com"));if(s.length>0)return s}return e}catch{return e}}function ne(e,t,r=!0){let o=f.get(e)||[];if(o.length===0)return null;let s=T(o.filter(i=>i.hasVideo||i.muxed),t);return s.length===0?null:oe(s,r)[0]||null}function S(e,t){let r=f.get(e)||[];if(r.length===0)return null;let o=T(r.filter(n=>n.hasAudio&&!n.hasVideo),t);if(o.length===0)return null;let s=[251,250,249,140];for(let n of s){let i=o.find(a=>a.itag===n);if(i)return i}return o.sort((n,i)=>i.timestamp-n.timestamp)[0]||null}function F(e){chrome.storage.local.get(["detectedMedia"],t=>{let r=t.detectedMedia||[];r.some(s=>s.url===e.url&&s.type===e.type&&s.tabId===e.tabId)||(r.push(e),chrome.storage.local.set({detectedMedia:r.slice(-100)}))})}function I(e){chrome.storage.local.get(["detectedResources"],t=>{let r=t.detectedResources||[];r.some(s=>s.url===e.url&&s.kind===e.kind&&s.tabId===e.tabId)||(r.push(e),chrome.storage.local.set({detectedResources:r.slice(-200)}))})}function ie(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"mydm-download",title:"Download with MyDM",contexts:["link","image","video","audio"]}),chrome.contextMenus.create({id:"mydm-download-page",title:"Download page URL with MyDM",contexts:["page"]})})}chrome.runtime.onInstalled.addListener(()=>{ie(),L(),ae()});chrome.runtime.onStartup.addListener(()=>{L()});async function ae(){try{await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[1,2]}),await chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{header:"Referer",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"https://www.youtube.com/"}]},condition:{urlFilter:"*://*.googlevideo.com/*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.MEDIA,chrome.declarativeNetRequest.ResourceType.OTHER]}},{id:2,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,requestHeaders:[{header:"Origin",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"https://www.youtube.com"}]},condition:{urlFilter:"*://*.googlevideo.com/*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.MEDIA,chrome.declarativeNetRequest.ResourceType.OTHER]}}]}),l("info","header_rules.installed",{rules:2})}catch(r){l("error","header_rules.install_failed",{error:b(r)})}}chrome.tabs.onRemoved.addListener(e=>{f.delete(e),H()});chrome.contextMenus.onClicked.addListener((e,t)=>{let r=e.linkUrl||e.srcUrl||e.pageUrl;r&&q("add_download",{url:r,referrer:t?.url||"",filename:e.selectionText||void 0})});chrome.runtime.onMessage.addListener((e,t,r)=>{let o=e.requestId||(typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`);return l("info","runtime.message",{requestId:o,type:e.type}),(async()=>{try{switch(e.type){case"download_with_mydm":{if(!e.url){r({success:!1,error:"Missing URL",requestId:o});return}let n=t.tab,i=await x(e.url,e.headers||{}),a=await q("add_download",{url:e.url,filename:e.filename,referrer:n?.url||"",headers:i});if(a.success){r({success:!0,error:a.error,requestId:a.requestId||o});return}l("info","download.fallback_chrome",{requestId:o,url:e.url.substring(0,100),nativeError:a.error});try{let d=await U(e.url,e.filename);r({success:!0,requestId:o,downloadId:d})}catch(d){r({success:!1,error:`Download failed: ${b(d)}`,requestId:o})}return}case"download_media":{if(!e.manifestUrl){r({success:!1,error:"Missing manifestUrl",requestId:o});return}let n=t.tab,i=await x(e.manifestUrl,e.headers||{}),a=await q("add_media_download",{manifestUrl:e.manifestUrl,mediaType:e.mediaType||"hls",quality:e.quality,title:e.title||n?.title||"",referrer:n?.url||"",headers:i});r({success:a.success,error:a.error,requestId:a.requestId||o});return}case"download_video":{if(!e.videoUrl){r({success:!1,error:"Missing videoUrl",requestId:o});return}let n=t.tab,i=await x(e.videoUrl,e.headers||{}),a=await q("add_video_download",{videoUrl:e.videoUrl,audioUrl:e.audioUrl||"",filename:e.filename,quality:e.quality,title:e.title||n?.title||"",referrer:n?.url||"",headers:i});if(a.success){r({success:!0,error:a.error,requestId:a.requestId||o});return}l("info","download_video.fallback_chrome",{requestId:o,videoUrl:e.videoUrl.substring(0,100),nativeError:a.error});try{let d=await U(e.videoUrl,e.filename);r({success:!0,requestId:o,downloadId:d})}catch(d){r({success:!1,error:`Download failed: ${b(d)}`,requestId:o})}return}case"get_connection_status":{let n=await L();r({connected:n.success,disconnectReason:n.success?"":n.error||_,requestId:n.requestId||o});return}case"resolve_video_source":{let n=t.tab?.id;if(typeof n!="number"){r({success:!1,error:"Cannot resolve source without tab context",requestId:o});return}let i=e.pageUrl||t.tab?.url||"",a=e.preferMuxed!==!1,d=ne(n,i,a);if(!d){r({success:!1,error:"No downloadable stream detected yet. Let the video play for a few seconds and try again.",requestId:o});return}let h="";if(!d.muxed&&d.hasVideo){let m=S(n,i);m&&(h=m.url)}l("info","stream.resolved",{requestId:o,tabId:n,pageUrl:i,url:d.url,audioUrl:h||void 0,itag:d.itag,quality:d.qualityLabel,muxed:d.muxed}),r({success:!0,requestId:o,url:d.url,audioUrl:h,quality:d.qualityLabel||"",mimeType:d.mimeType||"",muxed:d.muxed});return}case"list_stream_qualities":{let n=t.tab?.id;if(typeof n!="number"){r({success:!1,error:"No tab context",requestId:o});return}let i=e.pageUrl||t.tab?.url||"",a=f.get(n)||[],d=T(a,i),h=new Set,m=[],A=[...d].sort((u,c)=>u.muxed!==c.muxed?u.muxed?-1:1:c.height-u.height);for(let u of A){if(!u.hasVideo)continue;let c=`${u.qualityLabel||u.height}-${u.muxed?"m":"s"}`;if(h.has(c))continue;h.add(c);let w="";if(!u.muxed){let v=S(n,i);v&&(w=v.url)}m.push({url:u.url,audioUrl:w,itag:u.itag,quality:u.qualityLabel||`${u.height}p`,mimeType:u.mimeType||"",muxed:u.muxed,height:u.height,hasVideo:u.hasVideo,hasAudio:u.hasAudio})}l("info","stream.list_qualities",{tabId:n,count:m.length,qualities:m.map(u=>u.quality)}),r({success:!0,requestId:o,qualities:m});return}case"detected_media":{e.url&&F({url:e.url,type:e.mediaType||"unknown",tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()}),r({success:!0,requestId:o});return}case"detected_resources":{let n=e.resources||[];for(let i of n){let a=i.url,d=i.kind;typeof a!="string"||typeof d!="string"||I({...i,tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()})}r({success:!0,requestId:o,count:n.length});return}case"report_stream_url":{let n=e.url,i=t.tab?.id;if(typeof n=="string"&&typeof i=="number"){let a=P(n,i);a?(O(a),l("info","stream.accepted",{tabId:i,url:n.substring(0,100),itag:a.itag,quality:a.qualityLabel,muxed:a.muxed,hasVideo:a.hasVideo,hasAudio:a.hasAudio})):l("warn","stream.rejected_by_filter",{tabId:i,url:n.substring(0,120)})}r({success:!0,requestId:o});return}default:{r({success:!1,error:`Unsupported message type: ${e.type}`,requestId:o});return}}}catch(n){let i=b(n);l("error","runtime.message_failed",{requestId:o,type:e.type,error:i}),r({success:!1,error:i,requestId:o})}})(),!0});chrome.webRequest&&(chrome.webRequest.onHeadersReceived.addListener(e=>{if(e.responseHeaders){for(let t of e.responseHeaders)if(t.name.toLowerCase()==="content-type"&&t.value){let r=t.value.toLowerCase();C.some(o=>r.startsWith(o))&&E.set(e.requestId,t.value);break}}},{urls:["<all_urls>"],types:["xmlhttprequest","media","other"]},["responseHeaders"]),chrome.webRequest.onCompleted.addListener(e=>{let t=e.url.toLowerCase(),r=E.get(e.requestId);if(E.delete(e.requestId),t.includes(".m3u8")||t.includes(".mpd")){let s=t.includes(".m3u8")?"hls":"dash";F({url:e.url,type:s,tabId:e.tabId,timestamp:Date.now()})}else V(e.url)&&I({url:e.url,kind:"network_file",tabId:e.tabId,timestamp:Date.now()});let o=P(e.url,e.tabId,r);o&&(O(o),o.hasVideo&&I({url:o.url,kind:o.muxed?"network_video_muxed":"network_video_stream",tabId:e.tabId,timestamp:o.timestamp}))},{urls:["<all_urls>"],types:["xmlhttprequest","media","main_frame","sub_frame","other"]}));
