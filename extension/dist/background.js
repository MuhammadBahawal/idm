var v="com.mydm.native";var b=new Set(["zip","rar","7z","tar","gz","bz2","xz","iso","exe","msi","dmg","deb","rpm","apk","pdf","doc","docx","xls","xlsx","ppt","pptx","txt","csv","mp4","mkv","avi","mov","wmv","flv","webm","m4v","mp3","flac","wav","aac","ogg","wma","m4a","jpg","jpeg","png","gif","bmp","svg","webp"]),i=null,d="",a=new Map;function y(){return new Date().toISOString()}function p(e){return e instanceof Error?e.message:String(e)}function u(e,t,n={}){let r={ts:y(),level:e,event:t,...n};e==="error"?console.error("[MyDM]",t,n):e==="warn"?console.warn("[MyDM]",t,n):console.log("[MyDM]",t,n),chrome.storage.local.get(["debugLogs"],c=>{let o=c.debugLogs||[];o.push(r),chrome.storage.local.set({debugLogs:o.slice(-300),lastDebugLogAt:Date.now()})})}function l(e,t=""){chrome.storage.local.set({connectionStatus:e,disconnectReason:t,lastConnectionStateAt:Date.now()})}function w(e){let t=e.payload;return t&&typeof t=="object"?t:void 0}function I(e){let n=w(e)?.requestId;return typeof n=="string"?n:void 0}function R(e){if(e.type==="error"){let n=w(e)?.message;return typeof n=="string"&&n.trim().length>0?n:"Native host returned an error"}}function E(e){for(let[t,n]of a.entries())clearTimeout(n.timer),n.resolve({success:!1,error:e,requestId:t});a.clear()}function _(e){let t=I(e),n=R(e);if(u("info","native.message",{requestId:t,type:e.type??"unknown"}),chrome.storage.local.set({lastNativeResponse:e,lastNativeResponseAt:Date.now()}),!t)return;let r=a.get(t);r&&(clearTimeout(r.timer),a.delete(t),r.resolve({success:!n,error:n,response:e,requestId:t}))}function k(){let e=chrome.runtime.lastError?.message||"Native host disconnected";u("warn","native.disconnected",{reason:e}),d=e,i=null,l("disconnected",e),E(e)}function T(){if(i)return i;l("connecting");try{return i=chrome.runtime.connectNative(v),i.onMessage.addListener(_),i.onDisconnect.addListener(k),d="",l("connected"),u("info","native.connected"),i}catch(e){let t=p(e);return u("error","native.connect_failed",{reason:t}),d=t,l("error",t),i=null,null}}function f(e,t){let n=T();if(!n)return Promise.resolve({success:!1,error:d||"Native host not available. Is MyDM desktop app running?"});let r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,c={type:e,payload:{...t,requestId:r,source:"extension-background",sentAt:y()}};return new Promise(o=>{let s=setTimeout(()=>{a.delete(r),o({success:!1,error:"Timed out waiting for native host response",requestId:r})},15e3);a.set(r,{resolve:o,timer:s});try{n.postMessage(c),u("info","native.request_sent",{requestId:r,type:e})}catch(m){clearTimeout(s),a.delete(r),o({success:!1,error:`Failed to send request: ${p(m)}`,requestId:r})}})}async function g(){return f("healthcheck",{})}function x(e){try{let n=new URL(e).pathname.split("/").pop()||"",r=n.lastIndexOf(".");return r<=0?null:n.slice(r+1).toLowerCase()}catch{return null}}function U(e){let t=x(e);return t!==null&&b.has(t)}function h(e){chrome.storage.local.get(["detectedMedia"],t=>{let n=t.detectedMedia||[];n.some(c=>c.url===e.url&&c.type===e.type&&c.tabId===e.tabId)||(n.push(e),chrome.storage.local.set({detectedMedia:n.slice(-100)}))})}function M(e){chrome.storage.local.get(["detectedResources"],t=>{let n=t.detectedResources||[];n.some(c=>c.url===e.url&&c.kind===e.kind&&c.tabId===e.tabId)||(n.push(e),chrome.storage.local.set({detectedResources:n.slice(-200)}))})}function S(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"mydm-download",title:"Download with MyDM",contexts:["link","image","video","audio"]}),chrome.contextMenus.create({id:"mydm-download-page",title:"Download page URL with MyDM",contexts:["page"]})})}chrome.runtime.onInstalled.addListener(()=>{S(),g()});chrome.runtime.onStartup.addListener(()=>{g()});chrome.contextMenus.onClicked.addListener((e,t)=>{let n=e.linkUrl||e.srcUrl||e.pageUrl;n&&f("add_download",{url:n,referrer:t?.url||"",filename:e.selectionText||void 0})});chrome.runtime.onMessage.addListener((e,t,n)=>{let r=e.requestId||(typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`);return u("info","runtime.message",{requestId:r,type:e.type}),(async()=>{try{switch(e.type){case"download_with_mydm":{if(!e.url){n({success:!1,error:"Missing URL",requestId:r});return}let o=t.tab,s=await f("add_download",{url:e.url,filename:e.filename,referrer:o?.url||"",headers:e.headers||{}});n({success:s.success,error:s.error,requestId:s.requestId||r});return}case"download_media":{if(!e.manifestUrl){n({success:!1,error:"Missing manifestUrl",requestId:r});return}let o=t.tab,s=await f("add_media_download",{manifestUrl:e.manifestUrl,mediaType:e.mediaType||"hls",quality:e.quality,title:e.title||o?.title||"",referrer:o?.url||"",headers:e.headers||{}});n({success:s.success,error:s.error,requestId:s.requestId||r});return}case"get_connection_status":{let o=await g();n({connected:o.success,disconnectReason:o.success?"":o.error||d,requestId:o.requestId||r});return}case"detected_media":{e.url&&h({url:e.url,type:e.mediaType||"unknown",tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()}),n({success:!0,requestId:r});return}case"detected_resources":{let o=e.resources||[];for(let s of o){let m=s.url,D=s.kind;typeof m!="string"||typeof D!="string"||M({...s,tabId:t.tab?.id,title:t.tab?.title||"",timestamp:Date.now()})}n({success:!0,requestId:r,count:o.length});return}default:{n({success:!1,error:`Unsupported message type: ${e.type}`,requestId:r});return}}}catch(o){let s=p(o);u("error","runtime.message_failed",{requestId:r,type:e.type,error:s}),n({success:!1,error:s,requestId:r})}})(),!0});chrome.webRequest&&chrome.webRequest.onCompleted.addListener(e=>{let t=e.url.toLowerCase();if(t.includes(".m3u8")||t.includes(".mpd")){let n=t.includes(".m3u8")?"hls":"dash";h({url:e.url,type:n,tabId:e.tabId,timestamp:Date.now()})}else U(e.url)&&M({url:e.url,kind:"network_file",tabId:e.tabId,timestamp:Date.now()})},{urls:["<all_urls>"],types:["xmlhttprequest","media","main_frame","sub_frame","other"]});
