var oe=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,te=new WeakMap,J=new Set,ne=new WeakMap,K=new Set,P=new Set,X=null,G=location.href;function D(e){let t=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${t}`}function m(e,t,n={}){let r={event:t,...n};e==="error"?console.error("[MyDM]",r):e==="warn"?console.warn("[MyDM]",r):console.log("[MyDM]",r)}function ie(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function C(e){return ae(e,1e4)}function se(e){return ae(e,3e5)}function ae(e,t){return new Promise((n,r)=>{let o=!1,i=setTimeout(()=>{o||(o=!0,r(new Error("Timed out waiting for extension response")))},t);chrome.runtime.sendMessage(e,s=>{if(!o){if(o=!0,clearTimeout(i),chrome.runtime.lastError){r(new Error(chrome.runtime.lastError.message));return}n(s)}})})}function N(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function fe(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let t=e.querySelector("source[src]");return t?.src?t.src:null}function q(e){if(!e)return!1;try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function he(e){try{let n=new URL(e).pathname.split("/").pop()||"",r=n.lastIndexOf(".");if(r<=0)return null;let o=n.slice(r+1).toLowerCase();return!o||o.length>8?null:o}catch{return null}}function ge(e){if(!e)return"mp4";let t=e.toLowerCase();return t.includes("webm")?"webm":t.includes("audio/mp4")?"m4a":(t.includes("mp4"),"mp4")}function ye(e,t){try{let r=new URL(e).pathname.split("/").pop()||"",o=decodeURIComponent(r).trim();if(o.length>0)return N(o)}catch{}return N(t)}function j(){let e=location.hostname.toLowerCase();return e.includes("youtube.com")||e==="youtu.be"||e==="m.youtube.com"||e.endsWith("youtube-nocookie.com")}function Y(e){return`https://www.youtube.com/watch?v=${encodeURIComponent(e)}`}function F(e,t){let n=e.split("/").filter(Boolean);if(n.length<=t)return null;let r=n[t].trim();return r.length>0?r:null}function le(e){let t;try{t=new URL(e)}catch{return null}let n=t.hostname.toLowerCase();if(!(n.endsWith("youtube.com")||n==="youtu.be"||n==="m.youtube.com"||n.endsWith("youtube-nocookie.com")))return null;if(n==="youtu.be"){let r=F(t.pathname,0);return r?Y(r):null}if(t.pathname==="/redirect"){let r=t.searchParams.get("q");return r?le(r):null}if(t.pathname==="/watch"){let r=t.searchParams.get("v");return r?Y(r):null}if(t.pathname.startsWith("/shorts/")){let r=F(t.pathname,1);return r?Y(r):null}if(t.pathname.startsWith("/embed/")){let r=F(t.pathname,1);return r?Y(r):null}if(t.pathname.startsWith("/live/")){let r=F(t.pathname,1);return r?Y(r):null}return t.toString()}function be(){return le(location.href)||location.href}async function re(){try{let e=await C({type:"resolve_video_source",requestId:D("resolve"),pageUrl:location.href,preferMuxed:!0});return e?.success&&q(e.url)?e:(e?.error&&m("warn","resolve_video_source_failed",{error:e.error,pageUrl:location.href}),null)}catch(e){return m("warn","resolve_video_source_error",{error:String(e),pageUrl:location.href}),null}}async function ve(){try{let t=(await C({type:"list_stream_qualities",requestId:D("qualities"),pageUrl:location.href})).qualities;return Array.isArray(t)?t.filter(n=>!!(n&&typeof n.url=="string"&&typeof n.audioUrl=="string"&&typeof n.quality=="string"&&typeof n.mimeType=="string"&&typeof n.muxed=="boolean")):[]}catch(e){return m("warn","list_stream_qualities_failed",{error:String(e),pageUrl:location.href}),[]}}function we(e){return new Promise(t=>{document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=document.createElement("div");n.className="mydm-quality-modal";let r=document.createElement("div");r.className="mydm-modal-header",r.innerHTML='<span>Select Video Quality</span><button class="mydm-modal-close">X</button>',n.appendChild(r);let o=document.createElement("div");o.className="mydm-quality-list";for(let d of e){let a=d.quality||(d.height>0?`${d.height}p`:"Auto"),h=document.createElement("button");h.className="mydm-quality-item",h.innerHTML=`
                <span class="mydm-q-resolution">${a}</span>
                <span class="mydm-q-bitrate">${d.muxed?"video+audio":"video stream"}</span>
                <span class="mydm-q-codecs">${d.mimeType||"media"}</span>
            `,h.addEventListener("click",()=>{u(),t(d)}),o.appendChild(h)}let i=document.createElement("button");i.className="mydm-quality-item",i.textContent="Cancel",i.addEventListener("click",()=>{u(),t(null)}),o.appendChild(i),n.appendChild(o);let s=document.createElement("div");s.className="mydm-modal-backdrop";let u=()=>{n.remove(),s.remove()};r.querySelector(".mydm-modal-close")?.addEventListener("click",()=>{u(),t(null)}),s.addEventListener("click",()=>{u(),t(null)}),document.body.appendChild(s),document.body.appendChild(n)})}function Ee(e){return e<=0?"":e<1024*1024?`${(e/1024).toFixed(0)} KB`:e<1024*1024*1024?`${(e/(1024*1024)).toFixed(1)} MB`:`${(e/(1024*1024*1024)).toFixed(2)} GB`}async function xe(e){try{let t=D("ytfmt"),n=await se({type:"list_youtube_formats",url:e,youtubeUrl:e,requestId:t});return!n?.success||!Array.isArray(n.formats)?(m("warn","list_youtube_formats_failed",{error:n?.error||"No formats returned"}),[]):n.formats}catch(t){return m("error","list_youtube_formats_error",{error:String(t)}),[]}}function _e(e,t){return new Promise(n=>{document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let r=document.createElement("div");r.className="mydm-quality-modal",r.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2147483647;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.05);
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-width: 380px;
            max-width: 480px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: mydm-modal-in 0.25s ease-out;
        `;let o=document.createElement("style");o.textContent=`
            @keyframes mydm-modal-in {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.92); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        `,document.head.appendChild(o);let i=document.createElement("div");i.style.cssText=`
            padding: 16px 20px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
        `;let s=document.createElement("div");s.style.cssText="display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 0;";let u=document.createElement("span");u.textContent="Download Video",u.style.cssText="font-size: 15px; font-weight: 700; color: #fff;";let d=document.createElement("span");d.textContent=t.length>55?t.substring(0,55)+"...":t,d.style.cssText="font-size: 11px; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",s.appendChild(u),s.appendChild(d);let a=document.createElement("button");a.textContent="\u2715",a.style.cssText=`
            background: none; border: none; color: #94a3b8; font-size: 18px;
            cursor: pointer; padding: 4px 8px; border-radius: 6px;
            transition: all 0.15s ease;
        `,a.addEventListener("mouseenter",()=>{a.style.background="rgba(255,255,255,0.1)",a.style.color="#fff"}),a.addEventListener("mouseleave",()=>{a.style.background="none",a.style.color="#94a3b8"}),i.appendChild(s),i.appendChild(a),r.appendChild(i);let h=document.createElement("div");h.style.cssText=`
            overflow-y: auto;
            max-height: 400px;
            padding: 8px 12px 12px;
        `;for(let p of e){let T=p.qualityLabel||(p.height>0?`${p.height}p`:"Audio"),S=Ee(p.filesize),x=!p.hasVideo&&p.hasAudio,v=x?p.acodec!=="none"?p.acodec:p.ext:p.vcodec!=="none"?p.vcodec.split(".")[0]:p.ext,l=x?"\u{1F3B5} Audio":p.muxed?"\u{1F3AC} Video+Audio":"\u{1F3A5} Video",y=p.fps&&p.fps>30?` ${p.fps}fps`:"",f=document.createElement("button");f.style.cssText=`
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 14px;
                margin-bottom: 4px;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.06);
                border-radius: 10px;
                color: #e2e8f0;
                cursor: pointer;
                font-family: inherit;
                font-size: 13px;
                transition: all 0.15s ease;
            `,f.addEventListener("mouseenter",()=>{f.style.background="rgba(99, 102, 241, 0.15)",f.style.borderColor="rgba(99, 102, 241, 0.4)",f.style.transform="translateX(2px)"}),f.addEventListener("mouseleave",()=>{f.style.background="rgba(255, 255, 255, 0.03)",f.style.borderColor="rgba(255, 255, 255, 0.06)",f.style.transform="translateX(0)"});let _=document.createElement("div");_.style.cssText="display: flex; align-items: center; gap: 12px;";let R=document.createElement("span");R.textContent=T+y,R.style.cssText="font-weight: 600; font-size: 14px; min-width: 70px;";let O=document.createElement("span");O.textContent=l,O.style.cssText="font-size: 11px; color: #94a3b8;",_.appendChild(R),_.appendChild(O);let H=document.createElement("div");if(H.style.cssText="display: flex; align-items: center; gap: 10px; color: #64748b; font-size: 11px;",v){let L=document.createElement("span");L.textContent=v,L.style.cssText="padding: 2px 6px; background: rgba(255,255,255,0.06); border-radius: 4px; font-size: 10px;",H.appendChild(L)}let z=document.createElement("span");if(z.textContent=p.ext.toUpperCase(),z.style.cssText="padding: 2px 6px; background: rgba(99, 102, 241, 0.15); color: #818cf8; border-radius: 4px; font-size: 10px; font-weight: 600;",H.appendChild(z),S){let L=document.createElement("span");L.textContent=S,L.style.cssText="min-width: 55px; text-align: right; color: #94a3b8;",H.appendChild(L)}f.appendChild(_),f.appendChild(H),f.addEventListener("click",()=>{E(),n(p)}),h.appendChild(f)}r.appendChild(h);let b=document.createElement("div");b.className="mydm-modal-backdrop",b.style.cssText=`
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2147483646;
        `;let E=()=>{r.remove(),b.remove(),o.remove()};a.addEventListener("click",()=>{E(),n(null)}),b.addEventListener("click",()=>{E(),n(null)}),document.body.appendChild(b),document.body.appendChild(r)})}function W(e,t){try{return new URL(e,t).href}catch{return e}}function Z(e,t){let n=e.match(new RegExp(`${t}="([^"]*)"`));if(n)return n[1];let r=e.match(new RegExp(`${t}=([^,\\s]+)`));return r?r[1]:null}function Te(e,t){let n=[],r=e.split(`
`);for(let o=0;o<r.length;o++){let i=r[o].trim();if(!i.startsWith("#EXT-X-STREAM-INF:"))continue;let s=Z(i,"BANDWIDTH"),u=Z(i,"RESOLUTION"),d=Z(i,"CODECS");for(let a=o+1;a<r.length;a++){let h=r[a].trim();if(!(!h||h.startsWith("#"))){n.push({resolution:u||"Unknown",bandwidth:parseInt(s||"0",10),codecs:d||void 0,url:W(h,t)});break}}}return n.sort((o,i)=>i.bandwidth-o.bandwidth)}function Re(e,t){let n=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let u=parseInt(s.getAttribute("bandwidth")||"0",10),d=s.getAttribute("width"),a=s.getAttribute("height"),h=s.getAttribute("codecs")||void 0,b=s.querySelector("BaseURL")?.textContent?.trim(),E=d&&a?`${d}x${a}`:"Unknown";n.push({resolution:E,bandwidth:u,codecs:h,url:b?W(b,t):t})})}catch(r){m("warn","dash_parse_failed",{error:String(r)})}return n.sort((r,o)=>o.bandwidth-r.bandwidth)}function g(e,t=!1){let n=document.createElement("div");n.className="mydm-toast",t&&(n.style.background="linear-gradient(135deg, #EF4444, #DC2626)",n.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("mydm-toast-fadeout"),setTimeout(()=>n.remove(),500)},3e3)}function Le(e,t){return!e||!t?!1:e.includes(`Unsupported message type: ${t}`)}function Me(e){if(!e?.success)return!1;let t=typeof e.outputPath=="string"&&e.outputPath.trim().length>0,n=typeof e.runner=="string"&&e.runner.trim().length>0,r=typeof e.mode=="string"&&e.mode.trim().length>0;return t||n||r}async function U(e,t={}){let n=D("dl");try{let r=await C({...e,requestId:n,headers:ie()});if(r?.success)return r;let o=r?.error||"Unable to send download to MyDM",s=o.includes("Unsupported message type: download_youtube")?"Extension is outdated in this tab. Reload MyDM extension, refresh YouTube tab, and restart Chrome.":o;return m("error","download_request_rejected",{requestId:n,payloadType:typeof e.type=="string"?e.type:"unknown",rawError:o,finalError:s}),t.suppressErrorToast||g(`ERROR: ${s}`,!0),{...r||{},success:!1,error:s,rawError:o}}catch(r){let o=String(r);return t.suppressErrorToast||g(`ERROR: ${o}`,!0),{success:!1,error:o,rawError:o}}}async function Se(e,t,n,r){let o={youtubeUrl:e,filename:t,title:document.title,quality:"best",pageUrl:location.href,streamSource:"gui-overlay",clickTsIso:n,detectedVideoUrl:r||"",canonicalYoutubeUrl:e},i=await U({type:"download_youtube",url:r||"",...o},{suppressErrorToast:!0});if(i.success)return i;let s=i.rawError||i.error;return Le(s,"download_youtube")?(m("warn","gui.youtube.compat_legacy_fallback",{pageUrl:location.href,youtubeUrl:e,firstError:s||""}),U({type:"download_with_mydm",url:e,...o},{suppressErrorToast:!0})):i}async function Oe(e,t){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=[];try{let a=await(await fetch(e)).text();n=t==="hls"?Te(a,e):Re(a,e)}catch(d){m("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:t,error:String(d)})}if(n.length===0){(await U({type:"download_media",manifestUrl:e,mediaType:t,title:document.title})).success&&g("Sent to MyDM");return}let r=document.createElement("div");r.className="mydm-quality-modal";let o=document.createElement("div");o.className="mydm-modal-header",o.innerHTML='<span>MyDM - Select Quality</span><button class="mydm-modal-close">x</button>',r.appendChild(o);let i=document.createElement("div");i.className="mydm-quality-list";for(let d of n){let a=document.createElement("button");a.className="mydm-quality-item",a.innerHTML=`
            <span class="mydm-q-resolution">${d.resolution}</span>
            <span class="mydm-q-bitrate">${(d.bandwidth/1e3).toFixed(0)} kbps</span>
            ${d.codecs?`<span class="mydm-q-codecs">${d.codecs}</span>`:""}
        `,a.addEventListener("click",async()=>{(await U({type:"download_media",manifestUrl:d.url,mediaType:t,quality:d.resolution,title:document.title})).success&&g(`Downloading ${d.resolution} with MyDM`),r.remove(),s.remove()}),i.appendChild(a)}r.appendChild(i);let s=document.createElement("div");s.className="mydm-modal-backdrop";let u=()=>{r.remove(),s.remove()};o.querySelector(".mydm-modal-close")?.addEventListener("click",u),s.addEventListener("click",u),document.body.appendChild(s),document.body.appendChild(r)}function B(e){let t=e.video;if(!t.isConnected)return;let n=t.getBoundingClientRect(),r=n.width<120||n.height<80,o=n.bottom<0||n.right<0||n.top>window.innerHeight||n.left>window.innerWidth;if(r||o){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(n.left)}px`,e.host.style.top=`${Math.round(n.top)}px`,e.host.style.width=`${Math.round(n.width)}px`,e.host.style.height=`${Math.round(n.height)}px`}function ke(e){if(e.rafHandle!==null)return;let t=()=>{B(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(t):e.rafHandle=null};e.rafHandle=requestAnimationFrame(t)}function Ce(e){if(te.has(e))return;let t=document.createElement("div");t.className="mydm-overlay-host",t.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let n=t.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,n.appendChild(r);let o=document.createElement("button");o.className="mydm-btn",o.textContent="Download MyDM",o.title="Download with MyDM",n.appendChild(o),document.documentElement.appendChild(t);let i={video:e,host:t,button:o,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{i.hideTimer&&(clearTimeout(i.hideTimer),i.hideTimer=null)},u=()=>{s(),i.visible=!0,o.classList.add("visible"),B(i),ke(i)},d=()=>{s(),i.hideTimer=setTimeout(()=>{i.pointerOnVideo||i.pointerOnButton||(i.visible=!1,o.classList.remove("visible"))},550)},a=()=>{i.pointerOnVideo=!0,u()},h=()=>u(),b=()=>{i.pointerOnVideo=!1,d()},E=()=>{i.pointerOnButton=!0,u()},p=()=>{i.pointerOnButton=!1,d()};e.addEventListener("pointerenter",a,{passive:!0}),e.addEventListener("pointermove",h,{passive:!0}),e.addEventListener("pointerleave",b,{passive:!0}),o.addEventListener("pointerenter",E,{passive:!0}),o.addEventListener("pointerleave",p,{passive:!0});let T=()=>{i.visible&&B(i)};window.addEventListener("scroll",T,{passive:!0}),window.addEventListener("resize",T,{passive:!0}),typeof ResizeObserver<"u"&&(i.resizeObserver=new ResizeObserver(()=>B(i)),i.resizeObserver.observe(e)),o.addEventListener("click",async S=>{S.stopPropagation(),S.preventDefault();let x=new Date().toISOString(),v=fe(e);m("info","gui.icon_click",{clickTsIso:x,pageUrl:location.href,detectedVideoUrlAtClick:v||""});try{let c=await C({type:"get_connection_status"});c?.connected||m("info","native_host_not_connected_using_fallback",{reason:c?.disconnectReason||"MyDM desktop app is not running"})}catch(c){m("warn","connection_precheck_failed",{error:String(c)})}let l=v,y,f,_=!0,R,O="";if(j()){let c=be();if(!c){g("Unable to resolve YouTube video URL",!0);return}m("info","gui.youtube_url_resolved",{clickTsIso:x,pageUrl:location.href,detectedVideoUrlAtClick:v||"",canonicalYoutubeUrl:c}),g("Fetching available qualities...");let w=await xe(c);if(w.length>0){let M=await _e(w,document.title||"YouTube Video");if(!M){g("Download cancelled",!0);return}let I=`${N(document.title||"youtube_video")}.${M.ext||"mp4"}`;g(`Downloading ${M.qualityLabel}: ${I}`),se({type:"download_youtube_format",url:c,youtubeUrl:c,formatId:M.formatId,filename:I,title:document.title,quality:M.qualityLabel,pageUrl:location.href,streamSource:"gui-overlay",clickTsIso:x,detectedVideoUrl:v||"",canonicalYoutubeUrl:c,requestId:D("ytdl"),headers:ie()}).then(k=>{if(k?.success){let V=k.fileName||I;m("info","gui.youtube.format_download.done",{savedName:V,quality:M.qualityLabel}),g(`\u2705 Downloaded: ${V}`)}else{let V=k?.error||"Download failed";m("error","gui.youtube.format_download.fail",{error:V}),g(`Download failed: ${V}`,!0)}}).catch(k=>{m("error","gui.youtube.format_download.error",{error:String(k)}),g(`Download error: ${String(k)}`,!0)});return}else{m("warn","gui.youtube.format_list_empty_using_legacy",{youtubeUrl:c});let M=`${N(document.title||"youtube_video")}.mp4`,I=await Se(c,M,x,v||"");if(Me(I)){let k=I.fileName||M;g(`Saved with yt-dlp: ${k}`);return}O=I.error||""}m("warn","gui.youtube.all_routes_failed_trying_stream_fallback",{pageUrl:location.href,youtubeUrl:c,error:O}),g("Direct YouTube mode failed, trying stream fallback...")}if(m("info","download_button_clicked",{rawUrl:l,isHttp:q(l),pageUrl:location.href}),!q(l)){g("Finding downloadable stream...");try{document.dispatchEvent(new CustomEvent("mydm-request-scan"))}catch{}await new Promise(w=>setTimeout(w,500));let c=await re();(!c?.url||!q(c.url))&&(m("info","first_resolve_failed_retrying",{pageUrl:location.href}),await new Promise(w=>setTimeout(w,3e3)),c=await re()),c?.url&&q(c.url)?(l=c.url,y=c.quality||void 0,f=c.mimeType||void 0,_=c.muxed??!0,R=c.audioUrl||void 0,m("info","fallback_video_source_resolved",{url:l,audioUrl:R,quality:y,mimeType:f,muxed:_})):m("warn","fallback_resolution_failed",{fallbackError:c?.error||"no result",pageUrl:location.href})}if(!q(l)){j()&&O.trim().length>0?g(`YouTube download failed: ${O}`,!0):g("No downloadable stream found. Let the video play for a few seconds, then try again.",!0);return}if(j()||l.includes("googlevideo.com")){let c=await ve();if(c.length>0){let w=c.length===1?c[0]:await we(c);if(!w){g("Download cancelled",!0);return}l=w.url,R=w.audioUrl||void 0,_=w.muxed,y=w.quality||y,f=w.mimeType||f}}if(l.includes(".m3u8")||l.includes(".mpd")){await Oe(l,l.includes(".m3u8")?"hls":"dash");return}let z=he(l)||ge(f),L=y?`_${N(y).replace(/\s+/g,"")}`:"",ee=`${N(document.title||"video")}${L}.${z}`,Q;if(!_&&R?Q=await U({type:"download_video",videoUrl:l,audioUrl:R,filename:ee,quality:y||""}):Q=await U({type:"download_with_mydm",url:l,filename:ee}),Q.success){let c=y?` (${y})`:"";g(`Sent to MyDM${c}`)}}),i.cleanup=()=>{s(),i.rafHandle!==null&&(cancelAnimationFrame(i.rafHandle),i.rafHandle=null),i.resizeObserver?.disconnect(),window.removeEventListener("scroll",T),window.removeEventListener("resize",T),e.removeEventListener("pointerenter",a),e.removeEventListener("pointermove",h),e.removeEventListener("pointerleave",b),o.removeEventListener("pointerenter",E),o.removeEventListener("pointerleave",p),t.remove(),J.delete(i)},te.set(e,i),J.add(i),B(i)}function Ie(e){let t=e.currentSrc||e.src||e.getAttribute("src");if(!t)return null;let n=W(t,location.href);return!q(n)||n.startsWith("blob:")||n.startsWith("data:")?null:n}function qe(e){if(ne.has(e))return;let t=e.getBoundingClientRect();if(t.width<90||t.height<70)return;let n=document.createElement("div");n.className="mydm-image-overlay-host",n.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let r=n.attachShadow({mode:"open"}),o=document.createElement("style");o.textContent=`
        .mydm-img-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            color: #fff;
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            font-size: 11px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 6px 18px rgba(30, 64, 175, 0.35);
            white-space: nowrap;
        }
        .mydm-img-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .mydm-img-btn:hover {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
        }
    `,r.appendChild(o);let i=document.createElement("button");i.className="mydm-img-btn",i.textContent="Download Image",r.appendChild(i),document.documentElement.appendChild(n);let s={image:e,host:n,button:i,hideTimer:null,rafHandle:null,pointerOnImage:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},u=()=>{if(!e.isConnected)return;let l=e.getBoundingClientRect(),y=l.width<90||l.height<70,f=l.bottom<0||l.right<0||l.top>window.innerHeight||l.left>window.innerWidth;if(y||f){s.button.classList.remove("visible"),s.visible=!1;return}s.host.style.left=`${Math.round(l.left)}px`,s.host.style.top=`${Math.round(l.top)}px`,s.host.style.width=`${Math.round(l.width)}px`,s.host.style.height=`${Math.round(l.height)}px`},d=()=>{if(s.rafHandle!==null)return;let l=()=>{u(),s.visible||s.pointerOnButton||s.pointerOnImage?s.rafHandle=requestAnimationFrame(l):s.rafHandle=null};s.rafHandle=requestAnimationFrame(l)},a=()=>{s.hideTimer&&(clearTimeout(s.hideTimer),s.hideTimer=null)},h=()=>{a(),s.visible=!0,i.classList.add("visible"),u(),d()},b=()=>{a(),s.hideTimer=setTimeout(()=>{s.pointerOnImage||s.pointerOnButton||(s.visible=!1,i.classList.remove("visible"))},550)},E=()=>{s.pointerOnImage=!0,h()},p=()=>h(),T=()=>{s.pointerOnImage=!1,b()},S=()=>{s.pointerOnButton=!0,h()},x=()=>{s.pointerOnButton=!1,b()};e.addEventListener("pointerenter",E,{passive:!0}),e.addEventListener("pointermove",p,{passive:!0}),e.addEventListener("pointerleave",T,{passive:!0}),i.addEventListener("pointerenter",S,{passive:!0}),i.addEventListener("pointerleave",x,{passive:!0});let v=()=>{s.visible&&u()};window.addEventListener("scroll",v,{passive:!0}),window.addEventListener("resize",v,{passive:!0}),typeof ResizeObserver<"u"&&(s.resizeObserver=new ResizeObserver(()=>u()),s.resizeObserver.observe(e)),i.addEventListener("click",async l=>{l.stopPropagation(),l.preventDefault();let y=Ie(e);if(!y){g("Unable to resolve image URL",!0);return}let f=ye(y,"image_download");(await U({type:"download_with_mydm",url:y,filename:f})).success&&g("Image sent to MyDM")}),s.cleanup=()=>{a(),s.rafHandle!==null&&(cancelAnimationFrame(s.rafHandle),s.rafHandle=null),s.resizeObserver?.disconnect(),window.removeEventListener("scroll",v),window.removeEventListener("resize",v),e.removeEventListener("pointerenter",E),e.removeEventListener("pointermove",p),e.removeEventListener("pointerleave",T),i.removeEventListener("pointerenter",S),i.removeEventListener("pointerleave",x),n.remove(),K.delete(s)},ne.set(e,s),K.add(s),u()}function ce(){for(let e of Array.from(J))e.video.isConnected||e.cleanup();for(let e of Array.from(K))e.image.isConnected||e.cleanup()}function de(e=document){e.querySelectorAll("video").forEach(n=>Ce(n))}function ue(e=document){let t=e.querySelectorAll("img[src]"),n=0;for(let r of t)if(qe(r),n++,n>=250)break}function Ae(e,t){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||oe.test(e)?!0:t==="video"||t==="audio"}function me(e=document){let t=[],n=(r,o,i)=>{if(!Ae(r,o))return;let s=W(r,location.href),u=`${o}|${s}`;P.has(u)||(P.add(u),P.size>1500&&P.clear(),t.push({url:s,kind:o,source:i,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(r=>{let o=r,i=o.href||o.getAttribute("href");i&&(o.hasAttribute("download")||oe.test(i))&&n(i,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(r=>{let o=r.src;o&&n(o,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(r=>{let o=r.src||r.src;if(!o)return;let i=r.tagName.toLowerCase();n(o,i==="audio"?"audio":"video",`dom-${i}`)}),t.slice(0,120)}async function pe(e){if(e.length!==0)try{await C({type:"detected_resources",resources:e,requestId:D("detect")})}catch(t){m("warn","resource_report_failed",{error:String(t)})}}function A(e){X||(X=setTimeout(()=>{X=null,de(),ue(),ce(),pe(me()),m("info","rescan",{reason:e,url:location.href})},180))}function $(e){location.href!==G&&(G=location.href,m("info","spa_navigation",{reason:e,url:G}),A("url-change"),setTimeout(()=>A("url-change-delayed-1"),500),setTimeout(()=>A("url-change-delayed-2"),1400))}function Ue(){let e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),$("pushState")},history.replaceState=function(...n){t.apply(this,n),$("replaceState")},window.addEventListener("popstate",()=>$("popstate")),window.addEventListener("hashchange",()=>$("hashchange")),window.addEventListener("yt-navigate-finish",()=>$("yt-navigate-finish")),setInterval(()=>$("interval"),1200)}function De(){new MutationObserver(t=>{for(let n of t)n.type==="childList"?n.addedNodes.forEach(r=>{r instanceof Element&&(r.tagName==="VIDEO"||r.querySelector("video")?A("mutation-video"):r.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&A("mutation-resource"))}):n.type==="attributes"&&A("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function He(){let e=t=>{!t.includes(".m3u8")&&!t.includes(".mpd")||C({type:"detected_media",url:t,mediaType:t.includes(".m3u8")?"hls":"dash",requestId:D("manifest")}).catch(()=>{})};document.querySelectorAll("source[src], video[src], audio[src]").forEach(t=>{let n=t.getAttribute("src");n&&e(n)})}function $e(){window.addEventListener("message",e=>{if(e.source!==window||e.data?.type!=="MYDM_STREAM_INTERCEPT")return;let t=e.data.url,n=typeof e.data.source=="string"?e.data.source:"unknown";typeof t!="string"||!t.startsWith("http")||(m("info","main_world_stream_intercepted",{url:t.substring(0,120)}),C({type:"report_stream_url",url:t,pageUrl:location.href,streamSource:n}).catch(()=>{}))});try{let e=document.documentElement.dataset.mydmStreams;if(e){let t=JSON.parse(e),n=Array.isArray(t)?t:[];m("info","reading_pre_captured_urls",{count:n.length});for(let r of n){let o=typeof r=="string"?r:r&&typeof r=="object"&&typeof r.url=="string"?r.url:"",i=r&&typeof r=="object"&&typeof r.source=="string"?r.source:"unknown";o.startsWith("http")&&C({type:"report_stream_url",url:o,pageUrl:location.href,streamSource:i}).catch(()=>{})}}}catch{}}function Ne(){de(),ue(),pe(me()),De(),Ue(),He(),$e(),setInterval(()=>{ce(),document.visibilityState==="visible"&&A("periodic")},3e3)}Ne();
