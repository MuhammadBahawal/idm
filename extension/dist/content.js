var J=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,X=new WeakMap,F=new Set,j=new WeakMap,Q=new Set,D=new Set,B=null,P=location.href;function H(e){let t=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${t}`}function m(e,t,n={}){let r={event:t,...n};e==="error"?console.error("[MyDM]",r):e==="warn"?console.warn("[MyDM]",r):console.log("[MyDM]",r)}function le(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function w(e){return new Promise((t,n)=>{let r=!1,i=setTimeout(()=>{r||(r=!0,n(new Error("Timed out waiting for extension response")))},1e4);chrome.runtime.sendMessage(e,o=>{if(!r){if(r=!0,clearTimeout(i),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t(o)}})})}function C(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function ce(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let t=e.querySelector("source[src]");return t?.src?t.src:null}function M(e){if(!e)return!1;try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function ue(e){try{let n=new URL(e).pathname.split("/").pop()||"",r=n.lastIndexOf(".");if(r<=0)return null;let i=n.slice(r+1).toLowerCase();return!i||i.length>8?null:i}catch{return null}}function de(e){if(!e)return"mp4";let t=e.toLowerCase();return t.includes("webm")?"webm":t.includes("audio/mp4")?"m4a":(t.includes("mp4"),"mp4")}function me(e,t){try{let r=new URL(e).pathname.split("/").pop()||"",i=decodeURIComponent(r).trim();if(i.length>0)return C(i)}catch{}return C(t)}function Y(){let e=location.hostname.toLowerCase();return e.includes("youtube.com")||e==="youtu.be"||e==="m.youtube.com"||e.endsWith("youtube-nocookie.com")}function A(e){return`https://www.youtube.com/watch?v=${encodeURIComponent(e)}`}function N(e,t){let n=e.split("/").filter(Boolean);if(n.length<=t)return null;let r=n[t].trim();return r.length>0?r:null}function K(e){let t;try{t=new URL(e)}catch{return null}let n=t.hostname.toLowerCase();if(!(n.endsWith("youtube.com")||n==="youtu.be"||n==="m.youtube.com"||n.endsWith("youtube-nocookie.com")))return null;if(n==="youtu.be"){let r=N(t.pathname,0);return r?A(r):null}if(t.pathname==="/redirect"){let r=t.searchParams.get("q");return r?K(r):null}if(t.pathname==="/watch"){let r=t.searchParams.get("v");return r?A(r):null}if(t.pathname.startsWith("/shorts/")){let r=N(t.pathname,1);return r?A(r):null}if(t.pathname.startsWith("/embed/")){let r=N(t.pathname,1);return r?A(r):null}if(t.pathname.startsWith("/live/")){let r=N(t.pathname,1);return r?A(r):null}return t.toString()}function pe(){return K(location.href)||location.href}async function Z(){try{let e=await w({type:"resolve_video_source",requestId:H("resolve"),pageUrl:location.href,preferMuxed:!0});return e?.success&&M(e.url)?e:(e?.error&&m("warn","resolve_video_source_failed",{error:e.error,pageUrl:location.href}),null)}catch(e){return m("warn","resolve_video_source_error",{error:String(e),pageUrl:location.href}),null}}async function fe(){try{let t=(await w({type:"list_stream_qualities",requestId:H("qualities"),pageUrl:location.href})).qualities;return Array.isArray(t)?t.filter(n=>!!(n&&typeof n.url=="string"&&typeof n.audioUrl=="string"&&typeof n.quality=="string"&&typeof n.mimeType=="string"&&typeof n.muxed=="boolean")):[]}catch(e){return m("warn","list_stream_qualities_failed",{error:String(e),pageUrl:location.href}),[]}}function he(e){return new Promise(t=>{document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=document.createElement("div");n.className="mydm-quality-modal";let r=document.createElement("div");r.className="mydm-modal-header",r.innerHTML='<span>Select Video Quality</span><button class="mydm-modal-close">X</button>',n.appendChild(r);let i=document.createElement("div");i.className="mydm-quality-list";for(let l of e){let d=l.quality||(l.height>0?`${l.height}p`:"Auto"),p=document.createElement("button");p.className="mydm-quality-item",p.innerHTML=`
                <span class="mydm-q-resolution">${d}</span>
                <span class="mydm-q-bitrate">${l.muxed?"video+audio":"video stream"}</span>
                <span class="mydm-q-codecs">${l.mimeType||"media"}</span>
            `,p.addEventListener("click",()=>{u(),t(l)}),i.appendChild(p)}let o=document.createElement("button");o.className="mydm-quality-item",o.textContent="Cancel",o.addEventListener("click",()=>{u(),t(null)}),i.appendChild(o),n.appendChild(i);let s=document.createElement("div");s.className="mydm-modal-backdrop";let u=()=>{n.remove(),s.remove()};r.querySelector(".mydm-modal-close")?.addEventListener("click",()=>{u(),t(null)}),s.addEventListener("click",()=>{u(),t(null)}),document.body.appendChild(s),document.body.appendChild(n)})}function $(e,t){try{return new URL(e,t).href}catch{return e}}function W(e,t){let n=e.match(new RegExp(`${t}="([^"]*)"`));if(n)return n[1];let r=e.match(new RegExp(`${t}=([^,\\s]+)`));return r?r[1]:null}function ge(e,t){let n=[],r=e.split(`
`);for(let i=0;i<r.length;i++){let o=r[i].trim();if(!o.startsWith("#EXT-X-STREAM-INF:"))continue;let s=W(o,"BANDWIDTH"),u=W(o,"RESOLUTION"),l=W(o,"CODECS");for(let d=i+1;d<r.length;d++){let p=r[d].trim();if(!(!p||p.startsWith("#"))){n.push({resolution:u||"Unknown",bandwidth:parseInt(s||"0",10),codecs:l||void 0,url:$(p,t)});break}}}return n.sort((i,o)=>o.bandwidth-i.bandwidth)}function ye(e,t){let n=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let u=parseInt(s.getAttribute("bandwidth")||"0",10),l=s.getAttribute("width"),d=s.getAttribute("height"),p=s.getAttribute("codecs")||void 0,b=s.querySelector("BaseURL")?.textContent?.trim(),E=l&&d?`${l}x${d}`:"Unknown";n.push({resolution:E,bandwidth:u,codecs:p,url:b?$(b,t):t})})}catch(r){m("warn","dash_parse_failed",{error:String(r)})}return n.sort((r,i)=>i.bandwidth-r.bandwidth)}function h(e,t=!1){let n=document.createElement("div");n.className="mydm-toast",t&&(n.style.background="linear-gradient(135deg, #EF4444, #DC2626)",n.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("mydm-toast-fadeout"),setTimeout(()=>n.remove(),500)},3e3)}function ve(e,t){return!e||!t?!1:e.includes(`Unsupported message type: ${t}`)}function be(e){if(!e?.success)return!1;let t=typeof e.outputPath=="string"&&e.outputPath.trim().length>0,n=typeof e.runner=="string"&&e.runner.trim().length>0,r=typeof e.mode=="string"&&e.mode.trim().length>0;return t||n||r}async function L(e,t={}){let n=H("dl");try{let r=await w({...e,requestId:n,headers:le()});if(r?.success)return r;let i=r?.error||"Unable to send download to MyDM",s=i.includes("Unsupported message type: download_youtube")?"Extension is outdated in this tab. Reload MyDM extension, refresh YouTube tab, and restart Chrome.":i;return m("error","download_request_rejected",{requestId:n,payloadType:typeof e.type=="string"?e.type:"unknown",rawError:i,finalError:s}),t.suppressErrorToast||h(`ERROR: ${s}`,!0),{...r||{},success:!1,error:s,rawError:i}}catch(r){let i=String(r);return t.suppressErrorToast||h(`ERROR: ${i}`,!0),{success:!1,error:i,rawError:i}}}async function we(e,t,n,r){let i={youtubeUrl:e,filename:t,title:document.title,quality:"best",pageUrl:location.href,streamSource:"gui-overlay",clickTsIso:n,detectedVideoUrl:r||"",canonicalYoutubeUrl:e},o=await L({type:"download_youtube",url:r||"",...i},{suppressErrorToast:!0});if(o.success)return o;let s=o.rawError||o.error;return ve(s,"download_youtube")?(m("warn","gui.youtube.compat_legacy_fallback",{pageUrl:location.href,youtubeUrl:e,firstError:s||""}),L({type:"download_with_mydm",url:e,...i},{suppressErrorToast:!0})):o}async function Ee(e,t){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=[];try{let d=await(await fetch(e)).text();n=t==="hls"?ge(d,e):ye(d,e)}catch(l){m("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:t,error:String(l)})}if(n.length===0){(await L({type:"download_media",manifestUrl:e,mediaType:t,title:document.title})).success&&h("Sent to MyDM");return}let r=document.createElement("div");r.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>MyDM - Select Quality</span><button class="mydm-modal-close">x</button>',r.appendChild(i);let o=document.createElement("div");o.className="mydm-quality-list";for(let l of n){let d=document.createElement("button");d.className="mydm-quality-item",d.innerHTML=`
            <span class="mydm-q-resolution">${l.resolution}</span>
            <span class="mydm-q-bitrate">${(l.bandwidth/1e3).toFixed(0)} kbps</span>
            ${l.codecs?`<span class="mydm-q-codecs">${l.codecs}</span>`:""}
        `,d.addEventListener("click",async()=>{(await L({type:"download_media",manifestUrl:l.url,mediaType:t,quality:l.resolution,title:document.title})).success&&h(`Downloading ${l.resolution} with MyDM`),r.remove(),s.remove()}),o.appendChild(d)}r.appendChild(o);let s=document.createElement("div");s.className="mydm-modal-backdrop";let u=()=>{r.remove(),s.remove()};i.querySelector(".mydm-modal-close")?.addEventListener("click",u),s.addEventListener("click",u),document.body.appendChild(s),document.body.appendChild(r)}function U(e){let t=e.video;if(!t.isConnected)return;let n=t.getBoundingClientRect(),r=n.width<120||n.height<80,i=n.bottom<0||n.right<0||n.top>window.innerHeight||n.left>window.innerWidth;if(r||i){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(n.left)}px`,e.host.style.top=`${Math.round(n.top)}px`,e.host.style.width=`${Math.round(n.width)}px`,e.host.style.height=`${Math.round(n.height)}px`}function _e(e){if(e.rafHandle!==null)return;let t=()=>{U(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(t):e.rafHandle=null};e.rafHandle=requestAnimationFrame(t)}function Me(e){if(X.has(e))return;let t=document.createElement("div");t.className="mydm-overlay-host",t.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let n=t.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,n.appendChild(r);let i=document.createElement("button");i.className="mydm-btn",i.textContent="Download MyDM",i.title="Download with MyDM",n.appendChild(i),document.documentElement.appendChild(t);let o={video:e,host:t,button:i,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{o.hideTimer&&(clearTimeout(o.hideTimer),o.hideTimer=null)},u=()=>{s(),o.visible=!0,i.classList.add("visible"),U(o),_e(o)},l=()=>{s(),o.hideTimer=setTimeout(()=>{o.pointerOnVideo||o.pointerOnButton||(o.visible=!1,i.classList.remove("visible"))},550)},d=()=>{o.pointerOnVideo=!0,u()},p=()=>u(),b=()=>{o.pointerOnVideo=!1,l()},E=()=>{o.pointerOnButton=!0,u()},S=()=>{o.pointerOnButton=!1,l()};e.addEventListener("pointerenter",d,{passive:!0}),e.addEventListener("pointermove",p,{passive:!0}),e.addEventListener("pointerleave",b,{passive:!0}),i.addEventListener("pointerenter",E,{passive:!0}),i.addEventListener("pointerleave",S,{passive:!0});let _=()=>{o.visible&&U(o)};window.addEventListener("scroll",_,{passive:!0}),window.addEventListener("resize",_,{passive:!0}),typeof ResizeObserver<"u"&&(o.resizeObserver=new ResizeObserver(()=>U(o)),o.resizeObserver.observe(e)),i.addEventListener("click",async x=>{x.stopPropagation(),x.preventDefault();let T=new Date().toISOString(),y=ce(e);m("info","gui.icon_click",{clickTsIso:T,pageUrl:location.href,detectedVideoUrlAtClick:y||""});try{let c=await w({type:"get_connection_status"});c?.connected||m("info","native_host_not_connected_using_fallback",{reason:c?.disconnectReason||"MyDM desktop app is not running"})}catch(c){m("warn","connection_precheck_failed",{error:String(c)})}let a=y,f,v,I=!0,k,V="";if(Y()){let c=pe();if(!c){h("Unable to resolve YouTube video URL",!0);return}m("info","gui.youtube_url_resolved",{clickTsIso:T,pageUrl:location.href,detectedVideoUrlAtClick:y||"",canonicalYoutubeUrl:c});let g=`${C(document.title||"youtube_video")}.mp4`,q=await we(c,g,T,y||"");if(be(q)){let ae=q.fileName||g;h(`Saved with yt-dlp: ${ae}`);return}m("warn","gui.youtube.direct_failed_trying_stream_fallback",{pageUrl:location.href,youtubeUrl:c,error:q.error||"",unverifiedSuccess:!!q.success}),V=q.error||"",h("Direct YouTube mode failed, trying stream fallback...")}if(m("info","download_button_clicked",{rawUrl:a,isHttp:M(a),pageUrl:location.href}),!M(a)){h("Finding downloadable stream...");try{document.dispatchEvent(new CustomEvent("mydm-request-scan"))}catch{}await new Promise(g=>setTimeout(g,500));let c=await Z();(!c?.url||!M(c.url))&&(m("info","first_resolve_failed_retrying",{pageUrl:location.href}),await new Promise(g=>setTimeout(g,3e3)),c=await Z()),c?.url&&M(c.url)?(a=c.url,f=c.quality||void 0,v=c.mimeType||void 0,I=c.muxed??!0,k=c.audioUrl||void 0,m("info","fallback_video_source_resolved",{url:a,audioUrl:k,quality:f,mimeType:v,muxed:I})):m("warn","fallback_resolution_failed",{fallbackError:c?.error||"no result",pageUrl:location.href})}if(!M(a)){Y()&&V.trim().length>0?h(`YouTube download failed: ${V}`,!0):h("No downloadable stream found. Let the video play for a few seconds, then try again.",!0);return}if(Y()||a.includes("googlevideo.com")){let c=await fe();if(c.length>0){let g=c.length===1?c[0]:await he(c);if(!g){h("Download cancelled",!0);return}a=g.url,k=g.audioUrl||void 0,I=g.muxed,f=g.quality||f,v=g.mimeType||v}}if(a.includes(".m3u8")||a.includes(".mpd")){await Ee(a,a.includes(".m3u8")?"hls":"dash");return}let ie=ue(a)||de(v),se=f?`_${C(f).replace(/\s+/g,"")}`:"",G=`${C(document.title||"video")}${se}.${ie}`,z;if(!I&&k?z=await L({type:"download_video",videoUrl:a,audioUrl:k,filename:G,quality:f||""}):z=await L({type:"download_with_mydm",url:a,filename:G}),z.success){let c=f?` (${f})`:"";h(`Sent to MyDM${c}`)}}),o.cleanup=()=>{s(),o.rafHandle!==null&&(cancelAnimationFrame(o.rafHandle),o.rafHandle=null),o.resizeObserver?.disconnect(),window.removeEventListener("scroll",_),window.removeEventListener("resize",_),e.removeEventListener("pointerenter",d),e.removeEventListener("pointermove",p),e.removeEventListener("pointerleave",b),i.removeEventListener("pointerenter",E),i.removeEventListener("pointerleave",S),t.remove(),F.delete(o)},X.set(e,o),F.add(o),U(o)}function Re(e){let t=e.currentSrc||e.src||e.getAttribute("src");if(!t)return null;let n=$(t,location.href);return!M(n)||n.startsWith("blob:")||n.startsWith("data:")?null:n}function Le(e){if(j.has(e))return;let t=e.getBoundingClientRect();if(t.width<90||t.height<70)return;let n=document.createElement("div");n.className="mydm-image-overlay-host",n.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let r=n.attachShadow({mode:"open"}),i=document.createElement("style");i.textContent=`
        .mydm-img-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            color: #fff;
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            font-size: 11px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 6px 18px rgba(30, 64, 175, 0.35);
            white-space: nowrap;
        }
        .mydm-img-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .mydm-img-btn:hover {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
        }
    `,r.appendChild(i);let o=document.createElement("button");o.className="mydm-img-btn",o.textContent="Download Image",r.appendChild(o),document.documentElement.appendChild(n);let s={image:e,host:n,button:o,hideTimer:null,rafHandle:null,pointerOnImage:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},u=()=>{if(!e.isConnected)return;let a=e.getBoundingClientRect(),f=a.width<90||a.height<70,v=a.bottom<0||a.right<0||a.top>window.innerHeight||a.left>window.innerWidth;if(f||v){s.button.classList.remove("visible"),s.visible=!1;return}s.host.style.left=`${Math.round(a.left)}px`,s.host.style.top=`${Math.round(a.top)}px`,s.host.style.width=`${Math.round(a.width)}px`,s.host.style.height=`${Math.round(a.height)}px`},l=()=>{if(s.rafHandle!==null)return;let a=()=>{u(),s.visible||s.pointerOnButton||s.pointerOnImage?s.rafHandle=requestAnimationFrame(a):s.rafHandle=null};s.rafHandle=requestAnimationFrame(a)},d=()=>{s.hideTimer&&(clearTimeout(s.hideTimer),s.hideTimer=null)},p=()=>{d(),s.visible=!0,o.classList.add("visible"),u(),l()},b=()=>{d(),s.hideTimer=setTimeout(()=>{s.pointerOnImage||s.pointerOnButton||(s.visible=!1,o.classList.remove("visible"))},550)},E=()=>{s.pointerOnImage=!0,p()},S=()=>p(),_=()=>{s.pointerOnImage=!1,b()},x=()=>{s.pointerOnButton=!0,p()},T=()=>{s.pointerOnButton=!1,b()};e.addEventListener("pointerenter",E,{passive:!0}),e.addEventListener("pointermove",S,{passive:!0}),e.addEventListener("pointerleave",_,{passive:!0}),o.addEventListener("pointerenter",x,{passive:!0}),o.addEventListener("pointerleave",T,{passive:!0});let y=()=>{s.visible&&u()};window.addEventListener("scroll",y,{passive:!0}),window.addEventListener("resize",y,{passive:!0}),typeof ResizeObserver<"u"&&(s.resizeObserver=new ResizeObserver(()=>u()),s.resizeObserver.observe(e)),o.addEventListener("click",async a=>{a.stopPropagation(),a.preventDefault();let f=Re(e);if(!f){h("Unable to resolve image URL",!0);return}let v=me(f,"image_download");(await L({type:"download_with_mydm",url:f,filename:v})).success&&h("Image sent to MyDM")}),s.cleanup=()=>{d(),s.rafHandle!==null&&(cancelAnimationFrame(s.rafHandle),s.rafHandle=null),s.resizeObserver?.disconnect(),window.removeEventListener("scroll",y),window.removeEventListener("resize",y),e.removeEventListener("pointerenter",E),e.removeEventListener("pointermove",S),e.removeEventListener("pointerleave",_),o.removeEventListener("pointerenter",x),o.removeEventListener("pointerleave",T),n.remove(),Q.delete(s)},j.set(e,s),Q.add(s),u()}function ee(){for(let e of Array.from(F))e.video.isConnected||e.cleanup();for(let e of Array.from(Q))e.image.isConnected||e.cleanup()}function te(e=document){e.querySelectorAll("video").forEach(n=>Me(n))}function ne(e=document){let t=e.querySelectorAll("img[src]"),n=0;for(let r of t)if(Le(r),n++,n>=250)break}function Te(e,t){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||J.test(e)?!0:t==="video"||t==="audio"}function re(e=document){let t=[],n=(r,i,o)=>{if(!Te(r,i))return;let s=$(r,location.href),u=`${i}|${s}`;D.has(u)||(D.add(u),D.size>1500&&D.clear(),t.push({url:s,kind:i,source:o,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(r=>{let i=r,o=i.href||i.getAttribute("href");o&&(i.hasAttribute("download")||J.test(o))&&n(o,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(r=>{let i=r.src;i&&n(i,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(r=>{let i=r.src||r.src;if(!i)return;let o=r.tagName.toLowerCase();n(i,o==="audio"?"audio":"video",`dom-${o}`)}),t.slice(0,120)}async function oe(e){if(e.length!==0)try{await w({type:"detected_resources",resources:e,requestId:H("detect")})}catch(t){m("warn","resource_report_failed",{error:String(t)})}}function R(e){B||(B=setTimeout(()=>{B=null,te(),ne(),ee(),oe(re()),m("info","rescan",{reason:e,url:location.href})},180))}function O(e){location.href!==P&&(P=location.href,m("info","spa_navigation",{reason:e,url:P}),R("url-change"),setTimeout(()=>R("url-change-delayed-1"),500),setTimeout(()=>R("url-change-delayed-2"),1400))}function Oe(){let e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),O("pushState")},history.replaceState=function(...n){t.apply(this,n),O("replaceState")},window.addEventListener("popstate",()=>O("popstate")),window.addEventListener("hashchange",()=>O("hashchange")),window.addEventListener("yt-navigate-finish",()=>O("yt-navigate-finish")),setInterval(()=>O("interval"),1200)}function Se(){new MutationObserver(t=>{for(let n of t)n.type==="childList"?n.addedNodes.forEach(r=>{r instanceof Element&&(r.tagName==="VIDEO"||r.querySelector("video")?R("mutation-video"):r.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&R("mutation-resource"))}):n.type==="attributes"&&R("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function xe(){let e=t=>{!t.includes(".m3u8")&&!t.includes(".mpd")||w({type:"detected_media",url:t,mediaType:t.includes(".m3u8")?"hls":"dash",requestId:H("manifest")}).catch(()=>{})};document.querySelectorAll("source[src], video[src], audio[src]").forEach(t=>{let n=t.getAttribute("src");n&&e(n)})}function Ie(){window.addEventListener("message",e=>{if(e.source!==window||e.data?.type!=="MYDM_STREAM_INTERCEPT")return;let t=e.data.url,n=typeof e.data.source=="string"?e.data.source:"unknown";typeof t!="string"||!t.startsWith("http")||(m("info","main_world_stream_intercepted",{url:t.substring(0,120)}),w({type:"report_stream_url",url:t,pageUrl:location.href,streamSource:n}).catch(()=>{}))});try{let e=document.documentElement.dataset.mydmStreams;if(e){let t=JSON.parse(e),n=Array.isArray(t)?t:[];m("info","reading_pre_captured_urls",{count:n.length});for(let r of n){let i=typeof r=="string"?r:r&&typeof r=="object"&&typeof r.url=="string"?r.url:"",o=r&&typeof r=="object"&&typeof r.source=="string"?r.source:"unknown";i.startsWith("http")&&w({type:"report_stream_url",url:i,pageUrl:location.href,streamSource:o}).catch(()=>{})}}}catch{}}function ke(){te(),ne(),oe(re()),Se(),Oe(),xe(),Ie(),setInterval(()=>{ee(),document.visibilityState==="visible"&&R("periodic")},3e3)}ke();
