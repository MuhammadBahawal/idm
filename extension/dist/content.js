var D=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,_=new WeakMap,L=new Set,b=new Set,E=null,M=location.href;function T(e){let r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${r}`}function h(e,r,t={}){let n={event:r,...t};e==="error"?console.error("[MyDM]",n):e==="warn"?console.warn("[MyDM]",n):console.log("[MyDM]",n)}function $(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function O(e){return new Promise((r,t)=>{let n=!1,i=setTimeout(()=>{n||(n=!0,t(new Error("Timed out waiting for extension response")))},1e4);chrome.runtime.sendMessage(e,o=>{if(!n){if(n=!0,clearTimeout(i),chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}r(o)}})})}function N(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function z(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let r=e.querySelector("source[src]");return r?.src?r.src:null}function x(e,r){try{return new URL(e,r).href}catch{return e}}function R(e,r){let t=e.match(new RegExp(`${r}="([^"]*)"`));if(t)return t[1];let n=e.match(new RegExp(`${r}=([^,\\s]+)`));return n?n[1]:null}function V(e,r){let t=[],n=e.split(`
`);for(let i=0;i<n.length;i++){let o=n[i].trim();if(!o.startsWith("#EXT-X-STREAM-INF:"))continue;let s=R(o,"BANDWIDTH"),d=R(o,"RESOLUTION"),a=R(o,"CODECS");for(let c=i+1;c<n.length;c++){let l=n[c].trim();if(!(!l||l.startsWith("#"))){t.push({resolution:d||"Unknown",bandwidth:parseInt(s||"0",10),codecs:a||void 0,url:x(l,r)});break}}}return t.sort((i,o)=>o.bandwidth-i.bandwidth)}function B(e,r){let t=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let d=parseInt(s.getAttribute("bandwidth")||"0",10),a=s.getAttribute("width"),c=s.getAttribute("height"),l=s.getAttribute("codecs")||void 0,v=s.querySelector("BaseURL")?.textContent?.trim(),y=a&&c?`${a}x${c}`:"Unknown";t.push({resolution:y,bandwidth:d,codecs:l,url:v?x(v,r):r})})}catch(n){h("warn","dash_parse_failed",{error:String(n)})}return t.sort((n,i)=>i.bandwidth-n.bandwidth)}function p(e,r=!1){let t=document.createElement("div");t.className="mydm-toast",r&&(t.style.background="linear-gradient(135deg, #EF4444, #DC2626)",t.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("mydm-toast-fadeout"),setTimeout(()=>t.remove(),500)},3e3)}async function S(e){let r=T("dl");try{let t=await O({...e,requestId:r,headers:$()});return t?.success?!0:(p(`\u274C ${t?.error||"Unable to send download to MyDM"}`,!0),!1)}catch(t){return p(`\u274C ${String(t)}`,!0),!1}}async function U(e,r){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let t=[];try{let c=await(await fetch(e)).text();t=r==="hls"?V(c,e):B(c,e)}catch(a){h("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:r,error:String(a)})}if(t.length===0){await S({type:"download_media",manifestUrl:e,mediaType:r,title:document.title})&&p("\u2705 Sent to MyDM");return}let n=document.createElement("div");n.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>\u2B07 MyDM - Select Quality</span><button class="mydm-modal-close">\u2715</button>',n.appendChild(i);let o=document.createElement("div");o.className="mydm-quality-list";for(let a of t){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
            <span class="mydm-q-resolution">${a.resolution}</span>
            <span class="mydm-q-bitrate">${(a.bandwidth/1e3).toFixed(0)} kbps</span>
            ${a.codecs?`<span class="mydm-q-codecs">${a.codecs}</span>`:""}
        `,c.addEventListener("click",async()=>{await S({type:"download_media",manifestUrl:a.url,mediaType:r,quality:a.resolution,title:document.title})&&p(`\u2705 Downloading ${a.resolution} with MyDM`),n.remove(),s.remove()}),o.appendChild(c)}n.appendChild(o);let s=document.createElement("div");s.className="mydm-modal-backdrop";let d=()=>{n.remove(),s.remove()};i.querySelector(".mydm-modal-close")?.addEventListener("click",d),s.addEventListener("click",d),document.body.appendChild(s),document.body.appendChild(n)}function g(e){let r=e.video;if(!r.isConnected)return;let t=r.getBoundingClientRect(),n=t.width<120||t.height<80,i=t.bottom<0||t.right<0||t.top>window.innerHeight||t.left>window.innerWidth;if(n||i){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(t.left)}px`,e.host.style.top=`${Math.round(t.top)}px`,e.host.style.width=`${Math.round(t.width)}px`,e.host.style.height=`${Math.round(t.height)}px`}function P(e){if(e.rafHandle!==null)return;let r=()=>{g(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(r):e.rafHandle=null};e.rafHandle=requestAnimationFrame(r)}function X(e){if(_.has(e))return;let r=document.createElement("div");r.className="mydm-overlay-host",r.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let t=r.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,t.appendChild(n);let i=document.createElement("button");i.className="mydm-btn",i.textContent="\u2B07 MyDM",i.title="Download with MyDM",t.appendChild(i),document.documentElement.appendChild(r);let o={video:e,host:r,button:i,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{o.hideTimer&&(clearTimeout(o.hideTimer),o.hideTimer=null)},d=()=>{s(),o.visible=!0,i.classList.add("visible"),g(o),P(o)},a=()=>{s(),o.hideTimer=setTimeout(()=>{o.pointerOnVideo||o.pointerOnButton||(o.visible=!1,i.classList.remove("visible"))},550)},c=()=>{o.pointerOnVideo=!0,d()},l=()=>d(),v=()=>{o.pointerOnVideo=!1,a()},y=()=>{o.pointerOnButton=!0,d()},k=()=>{o.pointerOnButton=!1,a()};e.addEventListener("pointerenter",c,{passive:!0}),e.addEventListener("pointermove",l,{passive:!0}),e.addEventListener("pointerleave",v,{passive:!0}),i.addEventListener("pointerenter",y,{passive:!0}),i.addEventListener("pointerleave",k,{passive:!0});let w=()=>{o.visible&&g(o)};window.addEventListener("scroll",w,{passive:!0}),window.addEventListener("resize",w,{passive:!0}),typeof ResizeObserver<"u"&&(o.resizeObserver=new ResizeObserver(()=>g(o)),o.resizeObserver.observe(e)),i.addEventListener("click",async q=>{q.stopPropagation(),q.preventDefault();let m=z(e);if(!m){p("\u26A0 No downloadable source found",!0);return}if(m.includes(".m3u8")||m.includes(".mpd")){await U(m,m.includes(".m3u8")?"hls":"dash");return}await S({type:"download_with_mydm",url:m,filename:`${N(document.title||"video")}.mp4`})&&p("\u2705 Sent to MyDM")}),o.cleanup=()=>{s(),o.rafHandle!==null&&(cancelAnimationFrame(o.rafHandle),o.rafHandle=null),o.resizeObserver?.disconnect(),window.removeEventListener("scroll",w),window.removeEventListener("resize",w),e.removeEventListener("pointerenter",c),e.removeEventListener("pointermove",l),e.removeEventListener("pointerleave",v),i.removeEventListener("pointerenter",y),i.removeEventListener("pointerleave",k),r.remove(),L.delete(o)},_.set(e,o),L.add(o),g(o)}function A(){for(let e of Array.from(L))e.video.isConnected||e.cleanup()}function H(e=document){e.querySelectorAll("video").forEach(t=>X(t))}function F(e,r){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||D.test(e)?!0:r==="video"||r==="audio"}function C(e=document){let r=[],t=(n,i,o)=>{if(!F(n,i))return;let s=x(n,location.href),d=`${i}|${s}`;b.has(d)||(b.add(d),b.size>1500&&b.clear(),r.push({url:s,kind:i,source:o,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(n=>{let i=n,o=i.href||i.getAttribute("href");o&&(i.hasAttribute("download")||D.test(o))&&t(o,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(n=>{let i=n.src;i&&t(i,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(n=>{let i=n.src||n.src;if(!i)return;let o=n.tagName.toLowerCase();t(i,o==="audio"?"audio":"video",`dom-${o}`)}),r.slice(0,120)}async function I(e){if(e.length!==0)try{await O({type:"detected_resources",resources:e,requestId:T("detect")})}catch(r){h("warn","resource_report_failed",{error:String(r)})}}function u(e){E||(E=setTimeout(()=>{E=null,H(),A(),I(C()),h("info","rescan",{reason:e,url:location.href})},180))}function f(e){location.href!==M&&(M=location.href,h("info","spa_navigation",{reason:e,url:M}),u("url-change"),setTimeout(()=>u("url-change-delayed-1"),500),setTimeout(()=>u("url-change-delayed-2"),1400))}function Y(){let e=history.pushState,r=history.replaceState;history.pushState=function(...t){e.apply(this,t),f("pushState")},history.replaceState=function(...t){r.apply(this,t),f("replaceState")},window.addEventListener("popstate",()=>f("popstate")),window.addEventListener("hashchange",()=>f("hashchange")),window.addEventListener("yt-navigate-finish",()=>f("yt-navigate-finish")),setInterval(()=>f("interval"),1200)}function Q(){new MutationObserver(r=>{for(let t of r)t.type==="childList"?t.addedNodes.forEach(n=>{n instanceof Element&&(n.tagName==="VIDEO"||n.querySelector("video")?u("mutation-video"):n.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&u("mutation-resource"))}):t.type==="attributes"&&u("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function W(){let e=n=>{!n.includes(".m3u8")&&!n.includes(".mpd")||O({type:"detected_media",url:n,mediaType:n.includes(".m3u8")?"hls":"dash",requestId:T("manifest")}).catch(i=>{h("warn","detected_media_send_failed",{url:n,error:String(i)})})},r=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(n,i,o,s,d){e(i.toString()),r.call(this,n,i,o??!0,s,d)};let t=window.fetch;window.fetch=function(n,i){return e(n.toString()),t.call(this,n,i)}}function Z(){H(),I(C()),Q(),Y(),W(),setInterval(()=>{A(),document.visibilityState==="visible"&&u("periodic")},3e3)}Z();
