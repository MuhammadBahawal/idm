var I=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,C=new WeakMap,q=new Set,M=new Set,T=null,O=location.href;function L(e){let t=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${t}`}function m(e,t,n={}){let r={event:t,...n};e==="error"?console.error("[MyDM]",r):e==="warn"?console.warn("[MyDM]",r):console.log("[MyDM]",r)}function P(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function S(e){return new Promise((t,n)=>{let r=!1,o=setTimeout(()=>{r||(r=!0,n(new Error("Timed out waiting for extension response")))},1e4);chrome.runtime.sendMessage(e,i=>{if(!r){if(r=!0,clearTimeout(o),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t(i)}})})}function $(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function X(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let t=e.querySelector("source[src]");return t?.src?t.src:null}function R(e){if(!e)return!1;try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function Q(e){try{let n=new URL(e).pathname.split("/").pop()||"",r=n.lastIndexOf(".");if(r<=0)return null;let o=n.slice(r+1).toLowerCase();return!o||o.length>8?null:o}catch{return null}}function Y(e){if(!e)return"mp4";let t=e.toLowerCase();return t.includes("webm")?"webm":t.includes("audio/mp4")?"m4a":(t.includes("mp4"),"mp4")}async function W(){try{let e=await S({type:"resolve_video_source",requestId:L("resolve"),pageUrl:location.href,preferMuxed:!0});return e?.success&&R(e.url)?e:(e?.error&&m("warn","resolve_video_source_failed",{error:e.error,pageUrl:location.href}),null)}catch(e){return m("warn","resolve_video_source_error",{error:String(e),pageUrl:location.href}),null}}function D(e,t){try{return new URL(e,t).href}catch{return e}}function _(e,t){let n=e.match(new RegExp(`${t}="([^"]*)"`));if(n)return n[1];let r=e.match(new RegExp(`${t}=([^,\\s]+)`));return r?r[1]:null}function Z(e,t){let n=[],r=e.split(`
`);for(let o=0;o<r.length;o++){let i=r[o].trim();if(!i.startsWith("#EXT-X-STREAM-INF:"))continue;let s=_(i,"BANDWIDTH"),l=_(i,"RESOLUTION"),a=_(i,"CODECS");for(let c=o+1;c<r.length;c++){let u=r[c].trim();if(!(!u||u.startsWith("#"))){n.push({resolution:l||"Unknown",bandwidth:parseInt(s||"0",10),codecs:a||void 0,url:D(u,t)});break}}}return n.sort((o,i)=>i.bandwidth-o.bandwidth)}function j(e,t){let n=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let l=parseInt(s.getAttribute("bandwidth")||"0",10),a=s.getAttribute("width"),c=s.getAttribute("height"),u=s.getAttribute("codecs")||void 0,y=s.querySelector("BaseURL")?.textContent?.trim(),b=a&&c?`${a}x${c}`:"Unknown";n.push({resolution:b,bandwidth:l,codecs:u,url:y?D(y,t):t})})}catch(r){m("warn","dash_parse_failed",{error:String(r)})}return n.sort((r,o)=>o.bandwidth-r.bandwidth)}function v(e,t=!1){let n=document.createElement("div");n.className="mydm-toast",t&&(n.style.background="linear-gradient(135deg, #EF4444, #DC2626)",n.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("mydm-toast-fadeout"),setTimeout(()=>n.remove(),500)},3e3)}async function k(e){let t=L("dl");try{let n=await S({...e,requestId:t,headers:P()});return n?.success?!0:(v(`\u274C ${n?.error||"Unable to send download to MyDM"}`,!0),!1)}catch(n){return v(`\u274C ${String(n)}`,!0),!1}}async function G(e,t){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=[];try{let c=await(await fetch(e)).text();n=t==="hls"?Z(c,e):j(c,e)}catch(a){m("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:t,error:String(a)})}if(n.length===0){await k({type:"download_media",manifestUrl:e,mediaType:t,title:document.title})&&v("\u2705 Sent to MyDM");return}let r=document.createElement("div");r.className="mydm-quality-modal";let o=document.createElement("div");o.className="mydm-modal-header",o.innerHTML='<span>\u2B07 MyDM - Select Quality</span><button class="mydm-modal-close">\u2715</button>',r.appendChild(o);let i=document.createElement("div");i.className="mydm-quality-list";for(let a of n){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
            <span class="mydm-q-resolution">${a.resolution}</span>
            <span class="mydm-q-bitrate">${(a.bandwidth/1e3).toFixed(0)} kbps</span>
            ${a.codecs?`<span class="mydm-q-codecs">${a.codecs}</span>`:""}
        `,c.addEventListener("click",async()=>{await k({type:"download_media",manifestUrl:a.url,mediaType:t,quality:a.resolution,title:document.title})&&v(`\u2705 Downloading ${a.resolution} with MyDM`),r.remove(),s.remove()}),i.appendChild(c)}r.appendChild(i);let s=document.createElement("div");s.className="mydm-modal-backdrop";let l=()=>{r.remove(),s.remove()};o.querySelector(".mydm-modal-close")?.addEventListener("click",l),s.addEventListener("click",l),document.body.appendChild(s),document.body.appendChild(r)}function w(e){let t=e.video;if(!t.isConnected)return;let n=t.getBoundingClientRect(),r=n.width<120||n.height<80,o=n.bottom<0||n.right<0||n.top>window.innerHeight||n.left>window.innerWidth;if(r||o){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(n.left)}px`,e.host.style.top=`${Math.round(n.top)}px`,e.host.style.width=`${Math.round(n.width)}px`,e.host.style.height=`${Math.round(n.height)}px`}function J(e){if(e.rafHandle!==null)return;let t=()=>{w(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(t):e.rafHandle=null};e.rafHandle=requestAnimationFrame(t)}function K(e){if(C.has(e))return;let t=document.createElement("div");t.className="mydm-overlay-host",t.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let n=t.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,n.appendChild(r);let o=document.createElement("button");o.className="mydm-btn",o.textContent="\u2B07 MyDM",o.title="Download with MyDM",n.appendChild(o),document.documentElement.appendChild(t);let i={video:e,host:t,button:o,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{i.hideTimer&&(clearTimeout(i.hideTimer),i.hideTimer=null)},l=()=>{s(),i.visible=!0,o.classList.add("visible"),w(i),J(i)},a=()=>{s(),i.hideTimer=setTimeout(()=>{i.pointerOnVideo||i.pointerOnButton||(i.visible=!1,o.classList.remove("visible"))},550)},c=()=>{i.pointerOnVideo=!0,l()},u=()=>l(),y=()=>{i.pointerOnVideo=!1,a()},b=()=>{i.pointerOnButton=!0,l()},H=()=>{i.pointerOnButton=!1,a()};e.addEventListener("pointerenter",c,{passive:!0}),e.addEventListener("pointermove",u,{passive:!0}),e.addEventListener("pointerleave",y,{passive:!0}),o.addEventListener("pointerenter",b,{passive:!0}),o.addEventListener("pointerleave",H,{passive:!0});let E=()=>{i.visible&&w(i)};window.addEventListener("scroll",E,{passive:!0}),window.addEventListener("resize",E,{passive:!0}),typeof ResizeObserver<"u"&&(i.resizeObserver=new ResizeObserver(()=>w(i)),i.resizeObserver.observe(e)),o.addEventListener("click",async A=>{A.stopPropagation(),A.preventDefault();let d=X(e),h,x;if(!R(d)){let f=await W();f?.url&&R(f.url)&&(d=f.url,h=f.quality||void 0,x=f.mimeType||void 0,m("info","fallback_video_source_resolved",{url:d,quality:h,mimeType:x,muxed:f.muxed??null}))}if(!R(d)){v("\u26A0 No downloadable source found",!0);return}if(d.includes(".m3u8")||d.includes(".mpd")){await G(d,d.includes(".m3u8")?"hls":"dash");return}let B=Q(d)||Y(x),F=h?`_${$(h).replace(/\s+/g,"")}`:"";if(await k({type:"download_with_mydm",url:d,filename:`${$(document.title||"video")}${F}.${B}`})){let f=h?` (${h})`:"";v(`\u2705 Sent to MyDM${f}`)}}),i.cleanup=()=>{s(),i.rafHandle!==null&&(cancelAnimationFrame(i.rafHandle),i.rafHandle=null),i.resizeObserver?.disconnect(),window.removeEventListener("scroll",E),window.removeEventListener("resize",E),e.removeEventListener("pointerenter",c),e.removeEventListener("pointermove",u),e.removeEventListener("pointerleave",y),o.removeEventListener("pointerenter",b),o.removeEventListener("pointerleave",H),t.remove(),q.delete(i)},C.set(e,i),q.add(i),w(i)}function U(){for(let e of Array.from(q))e.video.isConnected||e.cleanup()}function N(e=document){e.querySelectorAll("video").forEach(n=>K(n))}function ee(e,t){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||I.test(e)?!0:t==="video"||t==="audio"}function V(e=document){let t=[],n=(r,o,i)=>{if(!ee(r,o))return;let s=D(r,location.href),l=`${o}|${s}`;M.has(l)||(M.add(l),M.size>1500&&M.clear(),t.push({url:s,kind:o,source:i,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(r=>{let o=r,i=o.href||o.getAttribute("href");i&&(o.hasAttribute("download")||I.test(i))&&n(i,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(r=>{let o=r.src;o&&n(o,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(r=>{let o=r.src||r.src;if(!o)return;let i=r.tagName.toLowerCase();n(o,i==="audio"?"audio":"video",`dom-${i}`)}),t.slice(0,120)}async function z(e){if(e.length!==0)try{await S({type:"detected_resources",resources:e,requestId:L("detect")})}catch(t){m("warn","resource_report_failed",{error:String(t)})}}function p(e){T||(T=setTimeout(()=>{T=null,N(),U(),z(V()),m("info","rescan",{reason:e,url:location.href})},180))}function g(e){location.href!==O&&(O=location.href,m("info","spa_navigation",{reason:e,url:O}),p("url-change"),setTimeout(()=>p("url-change-delayed-1"),500),setTimeout(()=>p("url-change-delayed-2"),1400))}function te(){let e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),g("pushState")},history.replaceState=function(...n){t.apply(this,n),g("replaceState")},window.addEventListener("popstate",()=>g("popstate")),window.addEventListener("hashchange",()=>g("hashchange")),window.addEventListener("yt-navigate-finish",()=>g("yt-navigate-finish")),setInterval(()=>g("interval"),1200)}function ne(){new MutationObserver(t=>{for(let n of t)n.type==="childList"?n.addedNodes.forEach(r=>{r instanceof Element&&(r.tagName==="VIDEO"||r.querySelector("video")?p("mutation-video"):r.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&p("mutation-resource"))}):n.type==="attributes"&&p("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function re(){let e=r=>{!r.includes(".m3u8")&&!r.includes(".mpd")||S({type:"detected_media",url:r,mediaType:r.includes(".m3u8")?"hls":"dash",requestId:L("manifest")}).catch(o=>{m("warn","detected_media_send_failed",{url:r,error:String(o)})})},t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(r,o,i,s,l){e(o.toString()),t.call(this,r,o,i??!0,s,l)};let n=window.fetch;window.fetch=function(r,o){return e(r.toString()),n.call(this,r,o)}}function oe(){N(),z(V()),ne(),te(),re(),setInterval(()=>{U(),document.visibilityState==="visible"&&p("periodic")},3e3)}oe();
