var Y=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,V=new WeakMap,$=new Set,P=new WeakMap,z=new Set,q=new Set,D=null,U=location.href;function k(e){let n=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${n}`}function f(e,n,t={}){let r={event:n,...t};e==="error"?console.error("[MyDM]",r):e==="warn"?console.warn("[MyDM]",r):console.log("[MyDM]",r)}function ee(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function E(e){return new Promise((n,t)=>{let r=!1,i=setTimeout(()=>{r||(r=!0,t(new Error("Timed out waiting for extension response")))},1e4);chrome.runtime.sendMessage(e,o=>{if(!r){if(r=!0,clearTimeout(i),chrome.runtime.lastError){t(new Error(chrome.runtime.lastError.message));return}n(o)}})})}function A(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function te(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let n=e.querySelector("source[src]");return n?.src?n.src:null}function _(e){if(!e)return!1;try{let n=new URL(e);return n.protocol==="http:"||n.protocol==="https:"}catch{return!1}}function ne(e){try{let t=new URL(e).pathname.split("/").pop()||"",r=t.lastIndexOf(".");if(r<=0)return null;let i=t.slice(r+1).toLowerCase();return!i||i.length>8?null:i}catch{return null}}function re(e){if(!e)return"mp4";let n=e.toLowerCase();return n.includes("webm")?"webm":n.includes("audio/mp4")?"m4a":(n.includes("mp4"),"mp4")}function oe(e,n){try{let r=new URL(e).pathname.split("/").pop()||"",i=decodeURIComponent(r).trim();if(i.length>0)return A(i)}catch{}return A(n)}function ie(){let e=location.hostname.toLowerCase();return e.includes("youtube.com")||e==="youtu.be"||e==="m.youtube.com"}async function F(){try{let e=await E({type:"resolve_video_source",requestId:k("resolve"),pageUrl:location.href,preferMuxed:!0});return e?.success&&_(e.url)?e:(e?.error&&f("warn","resolve_video_source_failed",{error:e.error,pageUrl:location.href}),null)}catch(e){return f("warn","resolve_video_source_error",{error:String(e),pageUrl:location.href}),null}}async function se(){try{let n=(await E({type:"list_stream_qualities",requestId:k("qualities"),pageUrl:location.href})).qualities;return Array.isArray(n)?n.filter(t=>!!(t&&typeof t.url=="string"&&typeof t.audioUrl=="string"&&typeof t.quality=="string"&&typeof t.mimeType=="string"&&typeof t.muxed=="boolean")):[]}catch(e){return f("warn","list_stream_qualities_failed",{error:String(e),pageUrl:location.href}),[]}}function ae(e){return new Promise(n=>{document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let t=document.createElement("div");t.className="mydm-quality-modal";let r=document.createElement("div");r.className="mydm-modal-header",r.innerHTML='<span>Select Video Quality</span><button class="mydm-modal-close">X</button>',t.appendChild(r);let i=document.createElement("div");i.className="mydm-quality-list";for(let a of e){let c=a.quality||(a.height>0?`${a.height}p`:"Auto"),m=document.createElement("button");m.className="mydm-quality-item",m.innerHTML=`
                <span class="mydm-q-resolution">${c}</span>
                <span class="mydm-q-bitrate">${a.muxed?"video+audio":"video stream"}</span>
                <span class="mydm-q-codecs">${a.mimeType||"media"}</span>
            `,m.addEventListener("click",()=>{l(),n(a)}),i.appendChild(m)}let o=document.createElement("button");o.className="mydm-quality-item",o.textContent="Cancel",o.addEventListener("click",()=>{l(),n(null)}),i.appendChild(o),t.appendChild(i);let s=document.createElement("div");s.className="mydm-modal-backdrop";let l=()=>{t.remove(),s.remove()};r.querySelector(".mydm-modal-close")?.addEventListener("click",()=>{l(),n(null)}),s.addEventListener("click",()=>{l(),n(null)}),document.body.appendChild(s),document.body.appendChild(t)})}function H(e,n){try{return new URL(e,n).href}catch{return e}}function N(e,n){let t=e.match(new RegExp(`${n}="([^"]*)"`));if(t)return t[1];let r=e.match(new RegExp(`${n}=([^,\\s]+)`));return r?r[1]:null}function le(e,n){let t=[],r=e.split(`
`);for(let i=0;i<r.length;i++){let o=r[i].trim();if(!o.startsWith("#EXT-X-STREAM-INF:"))continue;let s=N(o,"BANDWIDTH"),l=N(o,"RESOLUTION"),a=N(o,"CODECS");for(let c=i+1;c<r.length;c++){let m=r[c].trim();if(!(!m||m.startsWith("#"))){t.push({resolution:l||"Unknown",bandwidth:parseInt(s||"0",10),codecs:a||void 0,url:H(m,n)});break}}}return t.sort((i,o)=>o.bandwidth-i.bandwidth)}function ce(e,n){let t=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let l=parseInt(s.getAttribute("bandwidth")||"0",10),a=s.getAttribute("width"),c=s.getAttribute("height"),m=s.getAttribute("codecs")||void 0,w=s.querySelector("BaseURL")?.textContent?.trim(),M=a&&c?`${a}x${c}`:"Unknown";t.push({resolution:M,bandwidth:l,codecs:m,url:w?H(w,n):n})})}catch(r){f("warn","dash_parse_failed",{error:String(r)})}return t.sort((r,i)=>i.bandwidth-r.bandwidth)}function g(e,n=!1){let t=document.createElement("div");t.className="mydm-toast",n&&(t.style.background="linear-gradient(135deg, #EF4444, #DC2626)",t.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("mydm-toast-fadeout"),setTimeout(()=>t.remove(),500)},3e3)}async function I(e){let n=k("dl");try{let t=await E({...e,requestId:n,headers:ee()});return t?.success?!0:(g(`\u274C ${t?.error||"Unable to send download to MyDM"}`,!0),!1)}catch(t){return g(`\u274C ${String(t)}`,!0),!1}}async function de(e,n){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let t=[];try{let c=await(await fetch(e)).text();t=n==="hls"?le(c,e):ce(c,e)}catch(a){f("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:n,error:String(a)})}if(t.length===0){await I({type:"download_media",manifestUrl:e,mediaType:n,title:document.title})&&g("\u2705 Sent to MyDM");return}let r=document.createElement("div");r.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>\u2B07 MyDM - Select Quality</span><button class="mydm-modal-close">\u2715</button>',r.appendChild(i);let o=document.createElement("div");o.className="mydm-quality-list";for(let a of t){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
            <span class="mydm-q-resolution">${a.resolution}</span>
            <span class="mydm-q-bitrate">${(a.bandwidth/1e3).toFixed(0)} kbps</span>
            ${a.codecs?`<span class="mydm-q-codecs">${a.codecs}</span>`:""}
        `,c.addEventListener("click",async()=>{await I({type:"download_media",manifestUrl:a.url,mediaType:n,quality:a.resolution,title:document.title})&&g(`\u2705 Downloading ${a.resolution} with MyDM`),r.remove(),s.remove()}),o.appendChild(c)}r.appendChild(o);let s=document.createElement("div");s.className="mydm-modal-backdrop";let l=()=>{r.remove(),s.remove()};i.querySelector(".mydm-modal-close")?.addEventListener("click",l),s.addEventListener("click",l),document.body.appendChild(s),document.body.appendChild(r)}function x(e){let n=e.video;if(!n.isConnected)return;let t=n.getBoundingClientRect(),r=t.width<120||t.height<80,i=t.bottom<0||t.right<0||t.top>window.innerHeight||t.left>window.innerWidth;if(r||i){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(t.left)}px`,e.host.style.top=`${Math.round(t.top)}px`,e.host.style.width=`${Math.round(t.width)}px`,e.host.style.height=`${Math.round(t.height)}px`}function ue(e){if(e.rafHandle!==null)return;let n=()=>{x(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(n):e.rafHandle=null};e.rafHandle=requestAnimationFrame(n)}function me(e){if(V.has(e))return;let n=document.createElement("div");n.className="mydm-overlay-host",n.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let t=n.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,t.appendChild(r);let i=document.createElement("button");i.className="mydm-btn",i.textContent="\u2B07 MyDM",i.title="Download with MyDM",t.appendChild(i),document.documentElement.appendChild(n);let o={video:e,host:n,button:i,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{o.hideTimer&&(clearTimeout(o.hideTimer),o.hideTimer=null)},l=()=>{s(),o.visible=!0,i.classList.add("visible"),x(o),ue(o)},a=()=>{s(),o.hideTimer=setTimeout(()=>{o.pointerOnVideo||o.pointerOnButton||(o.visible=!1,i.classList.remove("visible"))},550)},c=()=>{o.pointerOnVideo=!0,l()},m=()=>l(),w=()=>{o.pointerOnVideo=!1,a()},M=()=>{o.pointerOnButton=!0,l()},T=()=>{o.pointerOnButton=!1,a()};e.addEventListener("pointerenter",c,{passive:!0}),e.addEventListener("pointermove",m,{passive:!0}),e.addEventListener("pointerleave",w,{passive:!0}),i.addEventListener("pointerenter",M,{passive:!0}),i.addEventListener("pointerleave",T,{passive:!0});let L=()=>{o.visible&&x(o)};window.addEventListener("scroll",L,{passive:!0}),window.addEventListener("resize",L,{passive:!0}),typeof ResizeObserver<"u"&&(o.resizeObserver=new ResizeObserver(()=>x(o)),o.resizeObserver.observe(e)),i.addEventListener("click",async S=>{S.stopPropagation(),S.preventDefault();try{let d=await E({type:"get_connection_status"});d?.connected||f("info","native_host_not_connected_using_fallback",{reason:d?.disconnectReason||"MyDM desktop app is not running"})}catch(d){f("warn","connection_precheck_failed",{error:String(d)})}let p=te(e),h,u,v=!0,b;if(f("info","download_button_clicked",{rawUrl:p,isHttp:_(p),pageUrl:location.href}),!_(p)){g("\u{1F50D} Finding downloadable stream\u2026");try{document.dispatchEvent(new CustomEvent("mydm-request-scan"))}catch{}await new Promise(y=>setTimeout(y,500));let d=await F();(!d?.url||!_(d.url))&&(f("info","first_resolve_failed_retrying",{pageUrl:location.href}),await new Promise(y=>setTimeout(y,3e3)),d=await F()),d?.url&&_(d.url)?(p=d.url,h=d.quality||void 0,u=d.mimeType||void 0,v=d.muxed??!0,b=d.audioUrl||void 0,f("info","fallback_video_source_resolved",{url:p,audioUrl:b,quality:h,mimeType:u,muxed:v})):f("warn","fallback_resolution_failed",{fallbackError:d?.error||"no result",pageUrl:location.href})}if(!_(p)){g("\u26A0 No downloadable stream found. Let the video play for a few seconds, then try again.",!0);return}if(ie()||p.includes("googlevideo.com")){let d=await se();if(d.length>0){let y=d.length===1?d[0]:await ae(d);if(!y){g("Download cancelled",!0);return}p=y.url,b=y.audioUrl||void 0,v=y.muxed,h=y.quality||h,u=y.mimeType||u}}if(p.includes(".m3u8")||p.includes(".mpd")){await de(p,p.includes(".m3u8")?"hls":"dash");return}let J=ne(p)||re(u),K=h?`_${A(h).replace(/\s+/g,"")}`:"",B=`${A(document.title||"video")}${K}.${J}`,C;if(!v&&b?C=await I({type:"download_video",videoUrl:p,audioUrl:b,filename:B,quality:h||""}):C=await I({type:"download_with_mydm",url:p,filename:B}),C){let d=h?` (${h})`:"";g(`\u2705 Sent to MyDM${d}`)}}),o.cleanup=()=>{s(),o.rafHandle!==null&&(cancelAnimationFrame(o.rafHandle),o.rafHandle=null),o.resizeObserver?.disconnect(),window.removeEventListener("scroll",L),window.removeEventListener("resize",L),e.removeEventListener("pointerenter",c),e.removeEventListener("pointermove",m),e.removeEventListener("pointerleave",w),i.removeEventListener("pointerenter",M),i.removeEventListener("pointerleave",T),n.remove(),$.delete(o)},V.set(e,o),$.add(o),x(o)}function pe(e){let n=e.currentSrc||e.src||e.getAttribute("src");if(!n)return null;let t=H(n,location.href);return!_(t)||t.startsWith("blob:")||t.startsWith("data:")?null:t}function fe(e){if(P.has(e))return;let n=e.getBoundingClientRect();if(n.width<90||n.height<70)return;let t=document.createElement("div");t.className="mydm-image-overlay-host",t.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let r=t.attachShadow({mode:"open"}),i=document.createElement("style");i.textContent=`
        .mydm-img-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            color: #fff;
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            font-size: 11px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 6px 18px rgba(30, 64, 175, 0.35);
            white-space: nowrap;
        }
        .mydm-img-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .mydm-img-btn:hover {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
        }
    `,r.appendChild(i);let o=document.createElement("button");o.className="mydm-img-btn",o.textContent="Download Image",r.appendChild(o),document.documentElement.appendChild(t);let s={image:e,host:t,button:o,hideTimer:null,rafHandle:null,pointerOnImage:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},l=()=>{if(!e.isConnected)return;let u=e.getBoundingClientRect(),v=u.width<90||u.height<70,b=u.bottom<0||u.right<0||u.top>window.innerHeight||u.left>window.innerWidth;if(v||b){s.button.classList.remove("visible"),s.visible=!1;return}s.host.style.left=`${Math.round(u.left)}px`,s.host.style.top=`${Math.round(u.top)}px`,s.host.style.width=`${Math.round(u.width)}px`,s.host.style.height=`${Math.round(u.height)}px`},a=()=>{if(s.rafHandle!==null)return;let u=()=>{l(),s.visible||s.pointerOnButton||s.pointerOnImage?s.rafHandle=requestAnimationFrame(u):s.rafHandle=null};s.rafHandle=requestAnimationFrame(u)},c=()=>{s.hideTimer&&(clearTimeout(s.hideTimer),s.hideTimer=null)},m=()=>{c(),s.visible=!0,o.classList.add("visible"),l(),a()},w=()=>{c(),s.hideTimer=setTimeout(()=>{s.pointerOnImage||s.pointerOnButton||(s.visible=!1,o.classList.remove("visible"))},550)},M=()=>{s.pointerOnImage=!0,m()},T=()=>m(),L=()=>{s.pointerOnImage=!1,w()},S=()=>{s.pointerOnButton=!0,m()},p=()=>{s.pointerOnButton=!1,w()};e.addEventListener("pointerenter",M,{passive:!0}),e.addEventListener("pointermove",T,{passive:!0}),e.addEventListener("pointerleave",L,{passive:!0}),o.addEventListener("pointerenter",S,{passive:!0}),o.addEventListener("pointerleave",p,{passive:!0});let h=()=>{s.visible&&l()};window.addEventListener("scroll",h,{passive:!0}),window.addEventListener("resize",h,{passive:!0}),typeof ResizeObserver<"u"&&(s.resizeObserver=new ResizeObserver(()=>l()),s.resizeObserver.observe(e)),o.addEventListener("click",async u=>{u.stopPropagation(),u.preventDefault();let v=pe(e);if(!v){g("Unable to resolve image URL",!0);return}let b=oe(v,"image_download");await I({type:"download_with_mydm",url:v,filename:b})&&g("Image sent to MyDM")}),s.cleanup=()=>{c(),s.rafHandle!==null&&(cancelAnimationFrame(s.rafHandle),s.rafHandle=null),s.resizeObserver?.disconnect(),window.removeEventListener("scroll",h),window.removeEventListener("resize",h),e.removeEventListener("pointerenter",M),e.removeEventListener("pointermove",T),e.removeEventListener("pointerleave",L),o.removeEventListener("pointerenter",S),o.removeEventListener("pointerleave",p),t.remove(),z.delete(s)},P.set(e,s),z.add(s),l()}function Q(){for(let e of Array.from($))e.video.isConnected||e.cleanup();for(let e of Array.from(z))e.image.isConnected||e.cleanup()}function W(e=document){e.querySelectorAll("video").forEach(t=>me(t))}function G(e=document){let n=e.querySelectorAll("img[src]"),t=0;for(let r of n)if(fe(r),t++,t>=250)break}function he(e,n){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||Y.test(e)?!0:n==="video"||n==="audio"}function X(e=document){let n=[],t=(r,i,o)=>{if(!he(r,i))return;let s=H(r,location.href),l=`${i}|${s}`;q.has(l)||(q.add(l),q.size>1500&&q.clear(),n.push({url:s,kind:i,source:o,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(r=>{let i=r,o=i.href||i.getAttribute("href");o&&(i.hasAttribute("download")||Y.test(o))&&t(o,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(r=>{let i=r.src;i&&t(i,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(r=>{let i=r.src||r.src;if(!i)return;let o=r.tagName.toLowerCase();t(i,o==="audio"?"audio":"video",`dom-${o}`)}),n.slice(0,120)}async function j(e){if(e.length!==0)try{await E({type:"detected_resources",resources:e,requestId:k("detect")})}catch(n){f("warn","resource_report_failed",{error:String(n)})}}function O(e){D||(D=setTimeout(()=>{D=null,W(),G(),Q(),j(X()),f("info","rescan",{reason:e,url:location.href})},180))}function R(e){location.href!==U&&(U=location.href,f("info","spa_navigation",{reason:e,url:U}),O("url-change"),setTimeout(()=>O("url-change-delayed-1"),500),setTimeout(()=>O("url-change-delayed-2"),1400))}function ve(){let e=history.pushState,n=history.replaceState;history.pushState=function(...t){e.apply(this,t),R("pushState")},history.replaceState=function(...t){n.apply(this,t),R("replaceState")},window.addEventListener("popstate",()=>R("popstate")),window.addEventListener("hashchange",()=>R("hashchange")),window.addEventListener("yt-navigate-finish",()=>R("yt-navigate-finish")),setInterval(()=>R("interval"),1200)}function ye(){new MutationObserver(n=>{for(let t of n)t.type==="childList"?t.addedNodes.forEach(r=>{r instanceof Element&&(r.tagName==="VIDEO"||r.querySelector("video")?O("mutation-video"):r.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&O("mutation-resource"))}):t.type==="attributes"&&O("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function ge(){let e=n=>{!n.includes(".m3u8")&&!n.includes(".mpd")||E({type:"detected_media",url:n,mediaType:n.includes(".m3u8")?"hls":"dash",requestId:k("manifest")}).catch(()=>{})};document.querySelectorAll("source[src], video[src], audio[src]").forEach(n=>{let t=n.getAttribute("src");t&&e(t)})}function be(){window.addEventListener("message",e=>{if(e.source!==window||e.data?.type!=="MYDM_STREAM_INTERCEPT")return;let n=e.data.url,t=typeof e.data.source=="string"?e.data.source:"unknown";typeof n!="string"||!n.startsWith("http")||(f("info","main_world_stream_intercepted",{url:n.substring(0,120)}),E({type:"report_stream_url",url:n,pageUrl:location.href,streamSource:t}).catch(()=>{}))});try{let e=document.documentElement.dataset.mydmStreams;if(e){let n=JSON.parse(e),t=Array.isArray(n)?n:[];f("info","reading_pre_captured_urls",{count:t.length});for(let r of t){let i=typeof r=="string"?r:r&&typeof r=="object"&&typeof r.url=="string"?r.url:"",o=r&&typeof r=="object"&&typeof r.source=="string"?r.source:"unknown";i.startsWith("http")&&E({type:"report_stream_url",url:i,pageUrl:location.href,streamSource:o}).catch(()=>{})}}}catch{}}function we(){W(),G(),j(X()),ye(),ve(),ge(),be(),setInterval(()=>{Q(),document.visibilityState==="visible"&&O("periodic")},3e3)}we();
