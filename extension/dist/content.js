var P=/\.(zip|rar|7z|tar|gz|bz2|xz|iso|exe|msi|dmg|deb|rpm|apk|pdf|docx?|xlsx?|pptx?|txt|csv|mp4|mkv|avi|mov|wmv|flv|webm|m4v|mp3|flac|wav|aac|ogg|wma|m4a|jpe?g|png|gif|bmp|svg|webp)(?:$|[?#])/i,V=new WeakMap,H=new Set,S=new Set,A=null,D=location.href;function T(e){let t=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`;return`${e}-${t}`}function d(e,t,n={}){let r={event:t,...n};e==="error"?console.error("[MyDM]",r):e==="warn"?console.warn("[MyDM]",r):console.log("[MyDM]",r)}function j(){let e={Referer:location.href,"User-Agent":navigator.userAgent};return document.cookie&&document.cookie.trim().length>0&&(e.Cookie=document.cookie),e}function v(e){return new Promise((t,n)=>{let r=!1,i=setTimeout(()=>{r||(r=!0,n(new Error("Timed out waiting for extension response")))},1e4);chrome.runtime.sendMessage(e,o=>{if(!r){if(r=!0,clearTimeout(i),chrome.runtime.lastError){n(new Error(chrome.runtime.lastError.message));return}t(o)}})})}function z(e){return e.replace(/[<>:"/\\|?*]+/g,"").trim()||"download"}function G(e){if(e.currentSrc&&e.currentSrc.trim().length>0)return e.currentSrc;if(e.src&&e.src.trim().length>0)return e.src;let t=e.querySelector("source[src]");return t?.src?t.src:null}function w(e){if(!e)return!1;try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function J(e){try{let n=new URL(e).pathname.split("/").pop()||"",r=n.lastIndexOf(".");if(r<=0)return null;let i=n.slice(r+1).toLowerCase();return!i||i.length>8?null:i}catch{return null}}function K(e){if(!e)return"mp4";let t=e.toLowerCase();return t.includes("webm")?"webm":t.includes("audio/mp4")?"m4a":(t.includes("mp4"),"mp4")}async function B(){try{let e=await v({type:"resolve_video_source",requestId:T("resolve"),pageUrl:location.href,preferMuxed:!0});return e?.success&&w(e.url)?e:(e?.error&&d("warn","resolve_video_source_failed",{error:e.error,pageUrl:location.href}),null)}catch(e){return d("warn","resolve_video_source_error",{error:String(e),pageUrl:location.href}),null}}function C(e,t){try{return new URL(e,t).href}catch{return e}}function U(e,t){let n=e.match(new RegExp(`${t}="([^"]*)"`));if(n)return n[1];let r=e.match(new RegExp(`${t}=([^,\\s]+)`));return r?r[1]:null}function ee(e,t){let n=[],r=e.split(`
`);for(let i=0;i<r.length;i++){let o=r[i].trim();if(!o.startsWith("#EXT-X-STREAM-INF:"))continue;let s=U(o,"BANDWIDTH"),u=U(o,"RESOLUTION"),a=U(o,"CODECS");for(let c=i+1;c<r.length;c++){let f=r[c].trim();if(!(!f||f.startsWith("#"))){n.push({resolution:u||"Unknown",bandwidth:parseInt(s||"0",10),codecs:a||void 0,url:C(f,t)});break}}}return n.sort((i,o)=>o.bandwidth-i.bandwidth)}function te(e,t){let n=[];try{new DOMParser().parseFromString(e,"application/xml").querySelectorAll("Representation[bandwidth]").forEach(s=>{let u=parseInt(s.getAttribute("bandwidth")||"0",10),a=s.getAttribute("width"),c=s.getAttribute("height"),f=s.getAttribute("codecs")||void 0,b=s.querySelector("BaseURL")?.textContent?.trim(),M=a&&c?`${a}x${c}`:"Unknown";n.push({resolution:M,bandwidth:u,codecs:f,url:b?C(b,t):t})})}catch(r){d("warn","dash_parse_failed",{error:String(r)})}return n.sort((r,i)=>i.bandwidth-r.bandwidth)}function h(e,t=!1){let n=document.createElement("div");n.className="mydm-toast",t&&(n.style.background="linear-gradient(135deg, #EF4444, #DC2626)",n.style.boxShadow="0 8px 24px rgba(239, 68, 68, 0.3)"),n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("mydm-toast-fadeout"),setTimeout(()=>n.remove(),500)},3e3)}async function L(e){let t=T("dl");try{let n=await v({...e,requestId:t,headers:j()});return n?.success?!0:(h(`\u274C ${n?.error||"Unable to send download to MyDM"}`,!0),!1)}catch(n){return h(`\u274C ${String(n)}`,!0),!1}}async function ne(e,t){document.querySelector(".mydm-quality-modal")?.remove(),document.querySelector(".mydm-modal-backdrop")?.remove();let n=[];try{let c=await(await fetch(e)).text();n=t==="hls"?ee(c,e):te(c,e)}catch(a){d("warn","manifest_fetch_failed",{manifestUrl:e,mediaType:t,error:String(a)})}if(n.length===0){await L({type:"download_media",manifestUrl:e,mediaType:t,title:document.title})&&h("\u2705 Sent to MyDM");return}let r=document.createElement("div");r.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>\u2B07 MyDM - Select Quality</span><button class="mydm-modal-close">\u2715</button>',r.appendChild(i);let o=document.createElement("div");o.className="mydm-quality-list";for(let a of n){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
            <span class="mydm-q-resolution">${a.resolution}</span>
            <span class="mydm-q-bitrate">${(a.bandwidth/1e3).toFixed(0)} kbps</span>
            ${a.codecs?`<span class="mydm-q-codecs">${a.codecs}</span>`:""}
        `,c.addEventListener("click",async()=>{await L({type:"download_media",manifestUrl:a.url,mediaType:t,quality:a.resolution,title:document.title})&&h(`\u2705 Downloading ${a.resolution} with MyDM`),r.remove(),s.remove()}),o.appendChild(c)}r.appendChild(o);let s=document.createElement("div");s.className="mydm-modal-backdrop";let u=()=>{r.remove(),s.remove()};i.querySelector(".mydm-modal-close")?.addEventListener("click",u),s.addEventListener("click",u),document.body.appendChild(s),document.body.appendChild(r)}function E(e){let t=e.video;if(!t.isConnected)return;let n=t.getBoundingClientRect(),r=n.width<120||n.height<80,i=n.bottom<0||n.right<0||n.top>window.innerHeight||n.left>window.innerWidth;if(r||i){e.button.classList.remove("visible"),e.visible=!1;return}e.host.style.left=`${Math.round(n.left)}px`,e.host.style.top=`${Math.round(n.top)}px`,e.host.style.width=`${Math.round(n.width)}px`,e.host.style.height=`${Math.round(n.height)}px`}function re(e){if(e.rafHandle!==null)return;let t=()=>{E(e),e.visible||e.pointerOnButton||e.pointerOnVideo?e.rafHandle=requestAnimationFrame(t):e.rafHandle=null};e.rafHandle=requestAnimationFrame(t)}function oe(e){if(V.has(e))return;let t=document.createElement("div");t.className="mydm-overlay-host",t.style.cssText=["position:fixed","left:0","top:0","width:0","height:0","pointer-events:none","z-index:2147483647"].join(";");let n=t.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=`
        :host {
            position: fixed;
            left: 0;
            top: 0;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 2147483647;
        }
        .mydm-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2147483647;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: pointer;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-2px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }
        .mydm-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mydm-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(0) scale(1.05);
        }
        .mydm-btn:active {
            transform: scale(0.97);
        }
    `,n.appendChild(r);let i=document.createElement("button");i.className="mydm-btn",i.textContent="\u2B07 MyDM",i.title="Download with MyDM",n.appendChild(i),document.documentElement.appendChild(t);let o={video:e,host:t,button:i,hideTimer:null,rafHandle:null,pointerOnVideo:!1,pointerOnButton:!1,visible:!1,resizeObserver:null,cleanup:()=>{}},s=()=>{o.hideTimer&&(clearTimeout(o.hideTimer),o.hideTimer=null)},u=()=>{s(),o.visible=!0,i.classList.add("visible"),E(o),re(o)},a=()=>{s(),o.hideTimer=setTimeout(()=>{o.pointerOnVideo||o.pointerOnButton||(o.visible=!1,i.classList.remove("visible"))},550)},c=()=>{o.pointerOnVideo=!0,u()},f=()=>u(),b=()=>{o.pointerOnVideo=!1,a()},M=()=>{o.pointerOnButton=!0,u()},$=()=>{o.pointerOnButton=!1,a()};e.addEventListener("pointerenter",c,{passive:!0}),e.addEventListener("pointermove",f,{passive:!0}),e.addEventListener("pointerleave",b,{passive:!0}),i.addEventListener("pointerenter",M,{passive:!0}),i.addEventListener("pointerleave",$,{passive:!0});let _=()=>{o.visible&&E(o)};window.addEventListener("scroll",_,{passive:!0}),window.addEventListener("resize",_,{passive:!0}),typeof ResizeObserver<"u"&&(o.resizeObserver=new ResizeObserver(()=>E(o)),o.resizeObserver.observe(e)),i.addEventListener("click",async I=>{I.stopPropagation(),I.preventDefault();try{let l=await v({type:"get_connection_status"});l?.connected||d("info","native_host_not_connected_using_fallback",{reason:l?.disconnectReason||"MyDM desktop app is not running"})}catch(l){d("warn","connection_precheck_failed",{error:String(l)})}let m=G(e),p,x,O=!0,R;if(d("info","download_button_clicked",{rawUrl:m,isHttp:w(m),pageUrl:location.href}),!w(m)){h("\u{1F50D} Finding downloadable stream\u2026");try{document.dispatchEvent(new CustomEvent("mydm-request-scan"))}catch{}await new Promise(q=>setTimeout(q,500));let l=await B();(!l?.url||!w(l.url))&&(d("info","first_resolve_failed_retrying",{pageUrl:location.href}),await new Promise(q=>setTimeout(q,3e3)),l=await B()),l?.url&&w(l.url)?(m=l.url,p=l.quality||void 0,x=l.mimeType||void 0,O=l.muxed??!0,R=l.audioUrl||void 0,d("info","fallback_video_source_resolved",{url:m,audioUrl:R,quality:p,mimeType:x,muxed:O})):d("warn","fallback_resolution_failed",{fallbackError:l?.error||"no result",pageUrl:location.href})}if(!w(m)){h("\u26A0 No downloadable stream found. Let the video play for a few seconds, then try again.",!0);return}if(m.includes(".m3u8")||m.includes(".mpd")){await ne(m,m.includes(".m3u8")?"hls":"dash");return}let Q=J(m)||K(x),Z=p?`_${z(p).replace(/\s+/g,"")}`:"",N=`${z(document.title||"video")}${Z}.${Q}`,k;if(!O&&R?k=await L({type:"download_video",videoUrl:m,audioUrl:R,filename:N,quality:p||""}):k=await L({type:"download_with_mydm",url:m,filename:N}),k){let l=p?` (${p})`:"";h(`\u2705 Sent to MyDM${l}`)}}),o.cleanup=()=>{s(),o.rafHandle!==null&&(cancelAnimationFrame(o.rafHandle),o.rafHandle=null),o.resizeObserver?.disconnect(),window.removeEventListener("scroll",_),window.removeEventListener("resize",_),e.removeEventListener("pointerenter",c),e.removeEventListener("pointermove",f),e.removeEventListener("pointerleave",b),i.removeEventListener("pointerenter",M),i.removeEventListener("pointerleave",$),t.remove(),H.delete(o)},V.set(e,o),H.add(o),E(o)}function F(){for(let e of Array.from(H))e.video.isConnected||e.cleanup()}function W(e=document){e.querySelectorAll("video").forEach(n=>oe(n))}function ie(e,t){return!e||e.startsWith("blob:")?!1:e.includes(".m3u8")||e.includes(".mpd")||P.test(e)?!0:t==="video"||t==="audio"}function X(e=document){let t=[],n=(r,i,o)=>{if(!ie(r,i))return;let s=C(r,location.href),u=`${i}|${s}`;S.has(u)||(S.add(u),S.size>1500&&S.clear(),t.push({url:s,kind:i,source:o,pageUrl:location.href,pageTitle:document.title||""}))};return e.querySelectorAll("a[href]").forEach(r=>{let i=r,o=i.href||i.getAttribute("href");o&&(i.hasAttribute("download")||P.test(o))&&n(o,"link","dom-anchor")}),e.querySelectorAll("img[src]").forEach(r=>{let i=r.src;i&&n(i,"image","dom-img")}),e.querySelectorAll("audio[src], video[src], source[src]").forEach(r=>{let i=r.src||r.src;if(!i)return;let o=r.tagName.toLowerCase();n(i,o==="audio"?"audio":"video",`dom-${o}`)}),t.slice(0,120)}async function Y(e){if(e.length!==0)try{await v({type:"detected_resources",resources:e,requestId:T("detect")})}catch(t){d("warn","resource_report_failed",{error:String(t)})}}function g(e){A||(A=setTimeout(()=>{A=null,W(),F(),Y(X()),d("info","rescan",{reason:e,url:location.href})},180))}function y(e){location.href!==D&&(D=location.href,d("info","spa_navigation",{reason:e,url:D}),g("url-change"),setTimeout(()=>g("url-change-delayed-1"),500),setTimeout(()=>g("url-change-delayed-2"),1400))}function se(){let e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),y("pushState")},history.replaceState=function(...n){t.apply(this,n),y("replaceState")},window.addEventListener("popstate",()=>y("popstate")),window.addEventListener("hashchange",()=>y("hashchange")),window.addEventListener("yt-navigate-finish",()=>y("yt-navigate-finish")),setInterval(()=>y("interval"),1200)}function ae(){new MutationObserver(t=>{for(let n of t)n.type==="childList"?n.addedNodes.forEach(r=>{r instanceof Element&&(r.tagName==="VIDEO"||r.querySelector("video")?g("mutation-video"):r.querySelector("a[href],img[src],audio[src],video[src],source[src]")&&g("mutation-resource"))}):n.type==="attributes"&&g("mutation-attr")}).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","href"]})}function le(){let e=t=>{!t.includes(".m3u8")&&!t.includes(".mpd")||v({type:"detected_media",url:t,mediaType:t.includes(".m3u8")?"hls":"dash",requestId:T("manifest")}).catch(()=>{})};document.querySelectorAll("source[src], video[src], audio[src]").forEach(t=>{let n=t.getAttribute("src");n&&e(n)})}function ce(){window.addEventListener("message",e=>{if(e.source!==window||e.data?.type!=="MYDM_STREAM_INTERCEPT")return;let t=e.data.url;typeof t!="string"||!t.startsWith("http")||(d("info","main_world_stream_intercepted",{url:t.substring(0,120)}),v({type:"report_stream_url",url:t,pageUrl:location.href}).catch(()=>{}))});try{let e=document.documentElement.dataset.mydmStreams;if(e){let t=JSON.parse(e);d("info","reading_pre_captured_urls",{count:t.length});for(let n of t)typeof n=="string"&&n.startsWith("http")&&v({type:"report_stream_url",url:n,pageUrl:location.href}).catch(()=>{})}}catch{}}function de(){W(),Y(X()),ae(),se(),le(),ce(),setInterval(()=>{F(),document.visibilityState==="visible"&&g("periodic")},3e3)}de();
