function y(t,e){let s=[],n=t.split(`
`);for(let i=0;i<n.length;i++){let o=n[i].trim();if(!o.startsWith("#EXT-X-STREAM-INF:"))continue;let a=u(o,"BANDWIDTH"),d=u(o,"RESOLUTION"),c=u(o,"CODECS");for(let l=i+1;l<n.length;l++){let m=n[l].trim();if(!(!m||m.startsWith("#"))){s.push({resolution:d||"Unknown",bandwidth:parseInt(a||"0"),codecs:c||void 0,url:h(m,e)});break}}}return s.sort((i,o)=>o.bandwidth-i.bandwidth)}function u(t,e){let s=t.match(new RegExp(`${e}="([^"]*)"`));if(s)return s[1];let n=t.match(new RegExp(`${e}=([^,\\s]+)`));return n?n[1]:null}function h(t,e){try{return new URL(t,e).href}catch{return t}}function p(t){if(t.dataset.mydmInjected)return;t.dataset.mydmInjected="true";let e=t.parentElement;if(!e)return;getComputedStyle(e).position==="static"&&(e.style.position="relative");let n=document.createElement("button");n.className="mydm-overlay-btn",n.textContent="\u2B07 MyDM",n.title="Download with MyDM",n.addEventListener("click",async i=>{i.stopPropagation(),i.preventDefault();let o=t.src||t.currentSrc,a=t.querySelectorAll("source");if(o&&(o.includes(".m3u8")||o.includes(".mpd")))f(o,o.includes(".m3u8")?"hls":"dash");else if(o)chrome.runtime.sendMessage({type:"download_with_mydm",url:o,filename:document.title+".mp4"}),r("Sent to MyDM");else if(a.length>0){let d=a[0].src;chrome.runtime.sendMessage({type:"download_with_mydm",url:d,filename:document.title+".mp4"}),r("Sent to MyDM")}else r("No downloadable source found")}),e.appendChild(n)}async function f(t,e){document.querySelector(".mydm-quality-modal")?.remove();let s=[];try{let c=await(await fetch(t)).text();e==="hls"&&(s=y(c,t))}catch(d){console.error("[MyDM] Failed to fetch manifest:",d),chrome.runtime.sendMessage({type:"download_media",manifestUrl:t,mediaType:e,title:document.title}),r("Sent to MyDM");return}if(s.length===0){chrome.runtime.sendMessage({type:"download_media",manifestUrl:t,mediaType:e,title:document.title}),r("Sent to MyDM");return}let n=document.createElement("div");n.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>\u2B07 MyDM \u2014 Select Quality</span><button class="mydm-modal-close">\u2715</button>',n.appendChild(i),i.querySelector(".mydm-modal-close").addEventListener("click",()=>n.remove());let o=document.createElement("div");o.className="mydm-quality-list";for(let d of s){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
      <span class="mydm-q-resolution">${d.resolution}</span>
      <span class="mydm-q-bitrate">${(d.bandwidth/1e3).toFixed(0)} kbps</span>
      ${d.codecs?`<span class="mydm-q-codecs">${d.codecs}</span>`:""}
    `,c.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"download_media",manifestUrl:d.url,mediaType:e,quality:d.resolution,title:document.title}),n.remove(),r(`Downloading ${d.resolution} with MyDM`)}),o.appendChild(c)}n.appendChild(o);let a=document.createElement("div");a.className="mydm-modal-backdrop",a.addEventListener("click",()=>{n.remove(),a.remove()}),document.body.appendChild(a),document.body.appendChild(n)}function r(t){let e=document.createElement("div");e.className="mydm-toast",e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.add("mydm-toast-fadeout"),setTimeout(()=>e.remove(),500)},2500)}var M=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,e,...s){let n=e.toString();return(n.includes(".m3u8")||n.includes(".mpd"))&&chrome.runtime.sendMessage({type:"detected_media",url:n,mediaType:n.includes(".m3u8")?"hls":"dash"}),M.apply(this,[t,e,...s])};var g=window.fetch;window.fetch=function(...t){let e=t[0]?.toString()||"";return(e.includes(".m3u8")||e.includes(".mpd"))&&chrome.runtime.sendMessage({type:"detected_media",url:e,mediaType:e.includes(".m3u8")?"hls":"dash"}),g.apply(this,t)};function w(){document.querySelectorAll("video").forEach(e=>p(e))}w();var v=new MutationObserver(t=>{for(let e of t)for(let s of e.addedNodes)s instanceof HTMLVideoElement&&p(s),s instanceof HTMLElement&&s.querySelectorAll("video").forEach(i=>p(i))});v.observe(document.body,{childList:!0,subtree:!0});
