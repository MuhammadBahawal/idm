function y(t,e){let o=[],n=t.split(`
`);for(let i=0;i<n.length;i++){let s=n[i].trim();if(!s.startsWith("#EXT-X-STREAM-INF:"))continue;let a=u(s,"BANDWIDTH"),r=u(s,"RESOLUTION"),d=u(s,"CODECS");for(let c=i+1;c<n.length;c++){let m=n[c].trim();if(!(!m||m.startsWith("#"))){o.push({resolution:r||"Unknown",bandwidth:parseInt(a||"0"),codecs:d||void 0,url:h(m,e)});break}}}return o.sort((i,s)=>s.bandwidth-i.bandwidth)}function u(t,e){let o=t.match(new RegExp(`${e}="([^"]*)"`));if(o)return o[1];let n=t.match(new RegExp(`${e}=([^,\\s]+)`));return n?n[1]:null}function h(t,e){try{return new URL(t,e).href}catch{return t}}function p(t){if(t.dataset.mydmInjected)return;t.dataset.mydmInjected="true";let e=t.parentElement;if(!e)return;getComputedStyle(e).position==="static"&&(e.style.position="relative");let n=document.createElement("button");n.className="mydm-overlay-btn",n.textContent="\u2B07 MyDM",n.title="Download with MyDM",n.addEventListener("click",i=>{i.stopPropagation(),i.preventDefault();let s=t.src||t.currentSrc,a=t.querySelectorAll("source");if(s&&(s.includes(".m3u8")||s.includes(".mpd")))f(s,s.includes(".m3u8")?"hls":"dash");else if(s)chrome.runtime.sendMessage({type:"download_with_mydm",url:s,filename:document.title+".mp4"}),l("Sent to MyDM");else if(a.length>0){let r=a[0].src;chrome.runtime.sendMessage({type:"download_with_mydm",url:r,filename:document.title+".mp4"}),l("Sent to MyDM")}else l("No downloadable source found")}),e.appendChild(n)}async function f(t,e){document.querySelector(".mydm-quality-modal")?.remove();let o=[];try{let c=await(await fetch(t)).text();e==="hls"&&(o=y(c,t))}catch(d){console.error("[MyDM] Failed to fetch manifest:",d),chrome.runtime.sendMessage({type:"download_media",manifestUrl:t,mediaType:e,title:document.title}),l("Sent to MyDM");return}if(o.length===0){chrome.runtime.sendMessage({type:"download_media",manifestUrl:t,mediaType:e,title:document.title}),l("Sent to MyDM");return}let n=document.createElement("div");n.className="mydm-quality-modal";let i=document.createElement("div");i.className="mydm-modal-header",i.innerHTML='<span>\u2B07 MyDM \u2014 Select Quality</span><button class="mydm-modal-close">\u2715</button>',n.appendChild(i);let s=i.querySelector(".mydm-modal-close");s&&s.addEventListener("click",()=>n.remove());let a=document.createElement("div");a.className="mydm-quality-list";for(let d of o){let c=document.createElement("button");c.className="mydm-quality-item",c.innerHTML=`
      <span class="mydm-q-resolution">${d.resolution}</span>
      <span class="mydm-q-bitrate">${(d.bandwidth/1e3).toFixed(0)} kbps</span>
      ${d.codecs?`<span class="mydm-q-codecs">${d.codecs}</span>`:""}
    `,c.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"download_media",manifestUrl:d.url,mediaType:e,quality:d.resolution,title:document.title}),n.remove(),r.remove(),l(`Downloading ${d.resolution} with MyDM`)}),a.appendChild(c)}n.appendChild(a);let r=document.createElement("div");r.className="mydm-modal-backdrop",r.addEventListener("click",()=>{n.remove(),r.remove()}),document.body.appendChild(r),document.body.appendChild(n)}function l(t){let e=document.createElement("div");e.className="mydm-toast",e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.classList.add("mydm-toast-fadeout"),setTimeout(()=>e.remove(),500)},2500)}var M=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,e,o,n,i){let s=e.toString();(s.includes(".m3u8")||s.includes(".mpd"))&&chrome.runtime.sendMessage({type:"detected_media",url:s,mediaType:s.includes(".m3u8")?"hls":"dash"}),M.call(this,t,e,o??!0,n,i)};var g=window.fetch;window.fetch=function(t,e){let o=t.toString();return(o.includes(".m3u8")||o.includes(".mpd"))&&chrome.runtime.sendMessage({type:"detected_media",url:o,mediaType:o.includes(".m3u8")?"hls":"dash"}),g.call(this,t,e)};function v(){document.querySelectorAll("video").forEach(e=>p(e))}v();var w=new MutationObserver(t=>{for(let e of t)e.addedNodes.forEach(o=>{o instanceof HTMLVideoElement&&p(o),o instanceof HTMLElement&&o.querySelectorAll("video").forEach(i=>p(i))})});w.observe(document.body,{childList:!0,subtree:!0});
