"use strict";(()=>{(function(){"use strict";let g="MYDM_STREAM_INTERCEPT",i=new Map,y=0;function p(t,e){if(!t||typeof t!="string"||i.has(t))return;let s=(e||"unknown").toLowerCase();i.set(t,s),y++,i.size>1e3&&[...i.keys()].slice(0,500).forEach(n=>i.delete(n));try{console.log(`[MyDM] \u{1F4E1} Captured stream (${e||"unknown"}):`,t.substring(0,120)),window.postMessage({type:g,url:t,source:s},"*")}catch{}h()}function h(){try{let t=[...i.entries()].map(([e,s])=>({url:e,source:s}));document.documentElement.dataset.mydmStreams=JSON.stringify(t)}catch{}}function M(){let t=[...i.entries()];console.log(`[MyDM] \u{1F501} Re-broadcasting ${t.length} captured URLs`);for(let[s,o]of t)try{window.postMessage({type:g,url:s,source:o},"*")}catch{}}let v=JSON.parse;JSON.parse=function(...t){let e=v.apply(this,t);try{e&&typeof e=="object"&&(e.streamingData&&(e.videoDetails||e.playabilityStatus)&&(console.log("[MyDM] \u{1F3AF} Intercepted YouTube player response via JSON.parse"),c(e,"json_parse")),e.playerResponse&&e.playerResponse.streamingData&&(console.log("[MyDM] \u{1F3AF} Intercepted nested playerResponse via JSON.parse"),c(e.playerResponse,"json_parse_nested")))}catch{}return e};function c(t,e){try{let s=t?.streamingData;if(!s){console.log("[MyDM] \u26A0 Player response has no streamingData property");return}let o=s.formats||[],n=s.adaptiveFormats||[],a=o.length+n.length;if(a===0){console.log("[MyDM] \u26A0 streamingData has 0 formats (video may be DRM-protected or age-restricted)");return}console.log(`[MyDM] \u2705 Found ${o.length} muxed + ${n.length} adaptive formats (source: ${e})`);let l=0;for(let d of o){let u=m(d);u&&(p(u,e),l++)}for(let d of n){let u=m(d);u&&(p(u,e),l++)}console.log(`[MyDM] \u{1F4CA} Captured ${l}/${a} stream URLs from this response`)}catch(s){console.log("[MyDM] \u274C Error parsing player response:",s)}}function m(t){if(t.url)return t.url;let e=t.signatureCipher||t.cipher;if(e)try{let s=new URLSearchParams(e),o=s.get("url"),n=s.get("sp")||"signature",a=s.get("sig")||s.get("signature"),l=s.get("s");return o?a?`${o}&${n}=${encodeURIComponent(a)}`:l?null:o:null}catch{return null}return null}let D=window.fetch;window.fetch=function(t,e){let s="";try{s=typeof t=="string"?t:t instanceof URL?t.toString():t.url}catch{}let o=D.call(this,t,e);return s&&(f(s)&&p(s,"fetch"),s.includes("/youtubei/v1/player")&&o.then(n=>{try{n.clone().json().then(a=>{console.log("[MyDM] \u{1F504} Intercepted /youtubei/v1/player fetch response"),c(a,"fetch_api")}).catch(()=>{})}catch{}}).catch(()=>{})),o};let R=XMLHttpRequest.prototype.open,S=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,e,s,o,n){let a=typeof e=="string"?e:e.toString();return this.__mydm_url=a,f(a)&&p(a,"xhr"),R.call(this,t,e,s??!0,o,n)},XMLHttpRequest.prototype.send=function(t){let e=this.__mydm_url;return e&&e.includes("/youtubei/v1/player")&&this.addEventListener("load",function(){try{if(this.responseType===""||this.responseType==="text"){let s=JSON.parse(this.responseText);console.log("[MyDM] \u{1F504} Intercepted /youtubei/v1/player XHR response"),c(s,"xhr_api")}}catch{}}),S.call(this,t)};function r(){let t=location.hostname.toLowerCase();if(!(!t.includes("youtube.com")&&t!=="youtu.be"&&t!=="m.youtube.com")){console.log(`[MyDM] \u{1F50D} Scanning for YouTube player data... (already captured: ${y})`);try{let e=window.ytInitialPlayerResponse;e&&e.streamingData&&c(e,"global_var")}catch{}try{let e=window.ytplayer;e?.config?.args?.raw_player_response?.streamingData&&c(e.config.args.raw_player_response,"ytplayer_config")}catch{}try{let e=document.querySelector("#movie_player");if(e&&typeof e.getPlayerResponse=="function"){let s=e.getPlayerResponse();s?.streamingData&&c(s,"player_api")}}catch{}}}document.addEventListener("yt-navigate-finish",()=>{console.log("[MyDM] \u{1F504} YouTube SPA navigation detected (yt-navigate-finish)"),i.clear(),y=0,setTimeout(r,500),setTimeout(r,2e3),setTimeout(r,5e3)}),document.addEventListener("yt-page-data-updated",()=>{console.log("[MyDM] \u{1F504} YouTube page data updated (yt-page-data-updated)"),setTimeout(r,300)});let w=history.pushState,T=history.replaceState;history.pushState=function(...t){let e=w.apply(this,t);return setTimeout(r,1e3),e},history.replaceState=function(...t){let e=T.apply(this,t);return setTimeout(r,1e3),e},window.addEventListener("popstate",()=>setTimeout(r,1e3));function f(t){let e=t.toLowerCase();if(e.includes("googlevideo.com/videoplayback")||e.includes("googlevideo.com")&&e.includes("itag=")||e.includes(".m3u8")||e.includes(".mpd"))return!0;let s=[".mp4",".webm",".m4v",".m4a",".m4s",".ts",".flv",".mkv",".mp3",".ogg",".opus",".aac",".wav"],o=e.split("?")[0];if(s.some(n=>o.endsWith(n)))return!0;try{let n=new URL(t);if(n.searchParams.has("itag")&&(n.searchParams.has("mime")||n.searchParams.has("clen")))return!0}catch{}return!1}console.log("[MyDM] \u{1F680} Inject script loaded (MAIN world)"),document.addEventListener("mydm-request-scan",()=>{console.log("[MyDM] \u{1F4E9} Scan requested by content script"),r(),setTimeout(M,100)}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(r,300),setTimeout(r,1500),setTimeout(r,4e3)}):(setTimeout(r,100),setTimeout(r,1e3),setTimeout(r,3e3))})();})();
