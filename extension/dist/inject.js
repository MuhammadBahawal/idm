"use strict";(()=>{(function(){"use strict";let g="MYDM_STREAM_INTERCEPT",i=new Map,d=0;function p(t,e){if(!t||typeof t!="string"||i.has(t))return;let n=(e||"unknown").toLowerCase();i.set(t,n),d++,i.size>1e3&&[...i.keys()].slice(0,500).forEach(o=>i.delete(o));try{console.log(`[MyDM] \u{1F4E1} Captured stream (${e||"unknown"}):`,t.substring(0,120)),window.postMessage({type:g,url:t,source:n},"*")}catch{}h()}function h(){try{let t=[...i.entries()].map(([e,n])=>({url:e,source:n}));document.documentElement.dataset.mydmStreams=JSON.stringify(t)}catch{}}function M(){let t=[...i.entries()];console.log(`[MyDM] \u{1F501} Re-broadcasting ${t.length} captured URLs`);for(let[n,s]of t)try{window.postMessage({type:g,url:n,source:s},"*")}catch{}}let v=JSON.parse;JSON.parse=function(...t){let e=v.apply(this,t);try{e&&typeof e=="object"&&(e.streamingData&&(e.videoDetails||e.playabilityStatus)&&(console.log("[MyDM] \u{1F3AF} Intercepted YouTube player response via JSON.parse"),c(e,"json_parse")),e.playerResponse&&e.playerResponse.streamingData&&(console.log("[MyDM] \u{1F3AF} Intercepted nested playerResponse via JSON.parse"),c(e.playerResponse,"json_parse_nested")))}catch{}return e};function c(t,e){try{let n=t?.streamingData;if(!n){console.log("[MyDM] \u26A0 Player response has no streamingData property");return}let s=n.formats||[],o=n.adaptiveFormats||[],a=s.length+o.length;if(a===0){console.log("[MyDM] \u26A0 streamingData has 0 formats (video may be DRM-protected or age-restricted)");return}console.log(`[MyDM] \u2705 Found ${s.length} muxed + ${o.length} adaptive formats (source: ${e})`);let u=0;for(let y of s){let l=m(y);l&&(p(l,e),u++)}for(let y of o){let l=m(y);l&&(p(l,e),u++)}console.log(`[MyDM] \u{1F4CA} Captured ${u}/${a} stream URLs from this response`)}catch(n){console.log("[MyDM] \u274C Error parsing player response:",n)}}function m(t){if(t.url)return t.url;let e=t.signatureCipher||t.cipher;if(e)try{let n=new URLSearchParams(e),s=n.get("url"),o=n.get("sp")||"signature",a=n.get("sig")||n.get("signature"),u=n.get("s");return s?a?`${s}&${o}=${encodeURIComponent(a)}`:u?null:s:null}catch{return null}return null}let D=window.fetch;window.fetch=function(t,e){let n="";try{n=typeof t=="string"?t:t instanceof URL?t.toString():t.url}catch{}let s=D.call(this,t,e);return n&&(f(n)&&p(n,"fetch"),n.includes("/youtubei/v1/player")&&s.then(o=>{try{o.clone().json().then(a=>{console.log("[MyDM] \u{1F504} Intercepted /youtubei/v1/player fetch response"),c(a,"fetch_api")}).catch(()=>{})}catch{}}).catch(()=>{})),s};let R=XMLHttpRequest.prototype.open,S=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,e,n,s,o){let a=typeof e=="string"?e:e.toString();return this.__mydm_url=a,f(a)&&p(a,"xhr"),R.call(this,t,e,n??!0,s,o)},XMLHttpRequest.prototype.send=function(t){let e=this.__mydm_url;return e&&e.includes("/youtubei/v1/player")&&this.addEventListener("load",function(){try{if(this.responseType===""||this.responseType==="text"){let n=JSON.parse(this.responseText);console.log("[MyDM] \u{1F504} Intercepted /youtubei/v1/player XHR response"),c(n,"xhr_api")}}catch{}}),S.call(this,t)};function r(){let t=location.hostname.toLowerCase();if(!(!t.includes("youtube.com")&&t!=="youtu.be"&&t!=="m.youtube.com")){console.log(`[MyDM] \u{1F50D} Scanning for YouTube player data... (already captured: ${d})`);try{let e=window.ytInitialPlayerResponse;e&&e.streamingData&&c(e,"global_var")}catch{}try{let e=window.ytplayer;e?.config?.args?.raw_player_response?.streamingData&&c(e.config.args.raw_player_response,"ytplayer_config")}catch{}try{let e=document.querySelector("#movie_player");if(e&&typeof e.getPlayerResponse=="function"){let n=e.getPlayerResponse();n?.streamingData&&c(n,"player_api")}}catch{}}}document.addEventListener("yt-navigate-finish",()=>{console.log("[MyDM] \u{1F504} YouTube SPA navigation detected (yt-navigate-finish)"),i.clear(),d=0,setTimeout(r,500),setTimeout(r,2e3),setTimeout(r,5e3)}),document.addEventListener("yt-page-data-updated",()=>{console.log("[MyDM] \u{1F504} YouTube page data updated (yt-page-data-updated)"),setTimeout(r,300)});let w=history.pushState,b=history.replaceState;history.pushState=function(...t){let e=w.apply(this,t);return setTimeout(r,1e3),e},history.replaceState=function(...t){let e=b.apply(this,t);return setTimeout(r,1e3),e},window.addEventListener("popstate",()=>setTimeout(r,1e3));function f(t){let e=t.toLowerCase();if(e.includes("googlevideo.com/videoplayback")||e.includes("googlevideo.com")&&e.includes("itag=")||(e.includes("cdninstagram.com")||e.includes("scontent"))&&(e.includes("/v/")||e.includes("/t50.")||e.includes("/t51."))||e.includes("fbcdn.net")&&(e.includes("/v/")||e.includes("video"))||e.includes("video.xx.fbcdn.net")||e.includes("video.twimg.com")||e.includes("abs.twimg.com")&&e.includes("video")||e.includes(".m3u8")||e.includes(".mpd"))return!0;let n=[".mp4",".webm",".m4v",".m4a",".m4s",".ts",".flv",".mkv",".mp3",".ogg",".opus",".aac",".wav"],s=e.split("?")[0];if(n.some(o=>s.endsWith(o)))return!0;try{let o=new URL(t);if(o.searchParams.has("itag")&&(o.searchParams.has("mime")||o.searchParams.has("clen")))return!0}catch{}return!1}console.log("[MyDM] \u{1F680} Inject script loaded (MAIN world)"),document.addEventListener("mydm-request-scan",()=>{console.log("[MyDM] \u{1F4E9} Scan requested by content script"),r(),setTimeout(M,100)}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(r,300),setTimeout(r,1500),setTimeout(r,4e3)}):(setTimeout(r,100),setTimeout(r,1e3),setTimeout(r,3e3))})();})();
