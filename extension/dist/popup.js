function l(o){return new Promise((e,c)=>{chrome.runtime.sendMessage(o,d=>{if(chrome.runtime.lastError){c(new Error(chrome.runtime.lastError.message));return}e(d)})})}function I(o){return o?o.replace(/_/g," ").trim():"resource"}function g(o){if(!o)return"download";try{let e=new URL(o);return decodeURIComponent(e.pathname.split("/").pop()||"")||e.hostname||"download"}catch{return"download"}}document.addEventListener("DOMContentLoaded",()=>{let o=document.getElementById("statusDot"),e=document.getElementById("statusText"),c=document.getElementById("mediaList"),d=document.getElementById("resourceList"),m=document.getElementById("urlInput"),p=document.getElementById("addBtn"),y=document.getElementById("optionsLink"),f=(n,s)=>{if(n){o?.classList.add("connected"),e&&(e.textContent="Connected to MyDM");return}o?.classList.remove("connected"),e&&(e.textContent=s?`Disconnected: ${s}`:"Not connected - is MyDM running?")},w=async()=>{try{let n=await l({type:"get_connection_status"});f(!!n.connected,n.disconnectReason)}catch(n){f(!1,String(n))}},v=async()=>{let[n]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=n?.id;chrome.storage.local.get(["detectedMedia"],u=>{let a=(u.detectedMedia||[]).filter(t=>s==null||t.tabId==null||t.tabId===s).slice(-10).reverse();if(c){if(c.innerHTML="",a.length===0){c.innerHTML='<div class="empty">No media detected on this page</div>';return}for(let t of a){if(!t.url)continue;let r=document.createElement("div");r.className="media-item",r.innerHTML=`
                    <span class="media-type ${t.type||""}">${t.type||"media"}</span>
                    <span class="media-title">${t.title||t.url||"Unknown"}</span>
                `,r.addEventListener("click",async()=>{try{let i=await l({type:"download_media",manifestUrl:t.url,mediaType:t.type,title:t.title});i.success?window.close():e&&(e.textContent=i.error||"Failed to send media download")}catch(i){e&&(e.textContent=String(i))}}),c.appendChild(r)}}})},R=async()=>{let[n]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=n?.id;chrome.storage.local.get(["detectedResources"],u=>{let a=(u.detectedResources||[]).filter(t=>s==null||t.tabId==null||t.tabId===s).slice(-20).reverse();if(d){if(d.innerHTML="",a.length===0){d.innerHTML='<div class="empty">No files/images detected on this page</div>';return}for(let t of a){if(!t.url)continue;let r=document.createElement("div");r.className="media-item",r.innerHTML=`
                    <span class="media-type resource">${I(t.kind)}</span>
                    <span class="media-title">${t.title||g(t.url)}</span>
                `,r.addEventListener("click",async()=>{try{let i=await l({type:"download_with_mydm",url:t.url,filename:g(t.url)});i.success?window.close():e&&(e.textContent=i.error||"Failed to start download")}catch(i){e&&(e.textContent=String(i))}}),d.appendChild(r)}}})};p?.addEventListener("click",async()=>{let n=m?.value?.trim();if(n)try{let s=await l({type:"download_with_mydm",url:n});s.success?window.close():e&&(e.textContent=s.error||"Failed to start download")}catch(s){e&&(e.textContent=String(s))}}),m?.addEventListener("keydown",n=>{n.key==="Enter"&&p?.click()}),y?.addEventListener("click",n=>{n.preventDefault(),chrome.runtime.openOptionsPage()}),w(),v(),R()});
