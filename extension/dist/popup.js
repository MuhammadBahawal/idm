function a(i){return new Promise((t,o)=>{chrome.runtime.sendMessage(i,r=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}t(r)})})}document.addEventListener("DOMContentLoaded",()=>{let i=document.getElementById("statusDot"),t=document.getElementById("statusText"),o=document.getElementById("mediaList"),r=document.getElementById("urlInput"),l=document.getElementById("addBtn"),p=document.getElementById("optionsLink"),m=(e,n)=>{if(e){i?.classList.add("connected"),t&&(t.textContent="Connected to MyDM");return}i?.classList.remove("connected"),t&&(t.textContent=n?`Disconnected: ${n}`:"Not connected - is MyDM running?")},y=async()=>{try{let e=await a({type:"get_connection_status"});m(!!e.connected,e.disconnectReason)}catch(e){m(!1,String(e))}},g=async()=>{let[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=e?.id;chrome.storage.local.get(["detectedMedia"],f=>{let u=(f.detectedMedia||[]).filter(s=>n==null||s.tabId==null||s.tabId===n).slice(-10).reverse();if(o){if(o.innerHTML="",u.length===0){o.innerHTML='<div class="empty">No media detected on this page</div>';return}for(let s of u){let d=document.createElement("div");d.className="media-item",d.innerHTML=`
                    <span class="media-type ${s.type||""}">${s.type||"unknown"}</span>
                    <span class="media-title">${s.title||s.url||"Unknown"}</span>
                `,d.addEventListener("click",async()=>{try{let c=await a({type:"download_media",manifestUrl:s.url,mediaType:s.type,title:s.title});c.success?window.close():t&&(t.textContent=c.error||"Failed to send media download")}catch(c){t&&(t.textContent=String(c))}}),o.appendChild(d)}}})};l?.addEventListener("click",async()=>{let e=r?.value?.trim();if(e)try{let n=await a({type:"download_with_mydm",url:e});n.success?window.close():t&&(t.textContent=n.error||"Failed to start download")}catch(n){t&&(t.textContent=String(n))}}),r?.addEventListener("keydown",e=>{e.key==="Enter"&&l?.click()}),p?.addEventListener("click",e=>{e.preventDefault(),chrome.runtime.openOptionsPage()}),y(),g()});
